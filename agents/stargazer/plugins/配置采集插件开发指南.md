# Stargazer é…ç½®é‡‡é›†æ’ä»¶å¼€å‘æŒ‡å—

> æœ¬æ–‡æ¡£å¸®åŠ©æ–°äººå¿«é€Ÿäº†è§£ Stargazer é…ç½®é‡‡é›†ç³»ç»Ÿçš„å·¥ä½œåŸç†ï¼Œå¹¶å­¦ä¼šå¦‚ä½•ç¼–å†™è‡ªå·±çš„é‡‡é›†æ’ä»¶ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
2. [é‡‡é›†é“¾è·¯è¯¦è§£](#é‡‡é›†é“¾è·¯è¯¦è§£)
3. [æ’ä»¶å¼€å‘å¿«é€Ÿä¸Šæ‰‹](#æ’ä»¶å¼€å‘å¿«é€Ÿä¸Šæ‰‹)
4. [æ•°æ®æ ¼å¼è§„èŒƒ](#æ•°æ®æ ¼å¼è§„èŒƒ) â­
5. [ä¸¤ç§é‡‡é›†æ–¹å¼è¯¦è§£](#ä¸¤ç§é‡‡é›†æ–¹å¼è¯¦è§£)
6. [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç³»ç»Ÿæ¦‚è§ˆ

### æ•´ä½“æ¶æ„

Stargazer æ˜¯ä¸€ä¸ªåŸºäº **Sanic + ARQ + Redis** çš„å¼‚æ­¥é‡‡é›†ç³»ç»Ÿï¼Œæ”¯æŒä¸¤ç§é‡‡é›†æ–¹å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Telegraf Agent                       â”‚
â”‚          (å‘é€ HTTP è¯·æ±‚ï¼Œæºå¸¦é‡‡é›†å‚æ•°)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Sanic API Server (server.py)               â”‚
â”‚          /api/collect/collect_info æ¥æ”¶è¯·æ±‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             TaskQueue (core/task_queue.py)              â”‚
â”‚           å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆåŸºäº Redis + ARQï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ARQ Worker (core/worker.py)                â”‚
â”‚            åå°å¼‚æ­¥æ‰§è¡Œé‡‡é›†ä»»åŠ¡                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        PluginExecutor (core/plugin_executor.py)         â”‚
â”‚          æ ¹æ® YAML é…ç½®åŠ è½½å¹¶æ‰§è¡Œé‡‡é›†å™¨                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Job (è„šæœ¬é‡‡é›†)   â”‚    â”‚ Protocol (åè®®)   â”‚
â”‚  SSHPlugin       â”‚    â”‚  Pythoné‡‡é›†å™¨      â”‚
â”‚  æ‰§è¡ŒShellè„šæœ¬    â”‚    â”‚  ç›´æ¥è¿æ¥æ•°æ®åº“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | ä½œç”¨ |
|------|---------|------|
| **API æ¥å£** | `api/collect.py` | æ¥æ”¶é‡‡é›†è¯·æ±‚ï¼Œè¿”å› Prometheus æ ¼å¼å“åº” |
| **ä»»åŠ¡é˜Ÿåˆ—** | `core/task_queue.py` | å°†é‡‡é›†ä»»åŠ¡åŠ å…¥ Redis é˜Ÿåˆ— |
| **å¼‚æ­¥Worker** | `core/worker.py` | ä»é˜Ÿåˆ—å–ä»»åŠ¡å¹¶æ‰§è¡Œ |
| **é‡‡é›†æœåŠ¡** | `service/collection_service.py` | è§£æå‚æ•°ï¼Œè°ƒç”¨æ’ä»¶æ‰§è¡Œå™¨ |
| **æ’ä»¶æ‰§è¡Œå™¨** | `core/plugin_executor.py` | æ ¹æ® YAML é…ç½®åŠ è½½é‡‡é›†å™¨ |
| **YAML è¯»å–å™¨** | `core/yaml_reader.py` | è¯»å–å¹¶è§£ææ’ä»¶é…ç½®æ–‡ä»¶ |

---

## é‡‡é›†é“¾è·¯è¯¦è§£

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ Telegraf å‘é€è¯·æ±‚                                         â”‚
â”‚    curl -X GET "http://localhost:8083/api/collect/collect_info" \
â”‚         -H "cmdbmodel_id: mysql"                             â”‚
â”‚         -H "cmdbhosts: 192.168.1.100"                        â”‚
â”‚         -H "cmdbport: 3306"                                  â”‚
â”‚         -H "cmdbuser: root"                                  â”‚
â”‚         -H "cmdbpassword: ****"                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£ API å±‚ (api/collect.py)                                  â”‚
â”‚    - è§£æ Headers ä¸­ cmdb* å‚æ•°                              â”‚
â”‚    - æå– instance_id, instance_type ç­‰æ ‡ç­¾                  â”‚
â”‚    - è°ƒç”¨ TaskQueue.enqueue_collect_task()                   â”‚
â”‚    - ç«‹å³è¿”å›"å·²æ¥æ”¶"æŒ‡æ ‡ï¼ˆPrometheus æ ¼å¼ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£ ä»»åŠ¡é˜Ÿåˆ— (core/task_queue.py)                            â”‚
â”‚    - ç”Ÿæˆå”¯ä¸€ task_idï¼ˆåŸºäºå‚æ•°å»é‡ï¼‰                         â”‚
â”‚    - å°†ä»»åŠ¡åŠ å…¥ Redis é˜Ÿåˆ—                                    â”‚
â”‚    - Redis Key: arq:queue                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£ ARQ Worker (core/worker.py)                              â”‚
â”‚    - ä» Redis å–å‡ºä»»åŠ¡                                        â”‚
â”‚    - è°ƒç”¨ collect_task() å…¥å£å‡½æ•°                            â”‚
â”‚    - åˆ†å‘åˆ° plugin_handler.py                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ï¸âƒ£ é‡‡é›†æœåŠ¡ (service/collection_service.py)                 â”‚
â”‚    - æ ¹æ® model_id è¯»å– YAML é…ç½®                            â”‚
â”‚    - ç¡®å®šæ‰§è¡Œå™¨ç±»å‹ï¼ˆjob æˆ– protocolï¼‰                        â”‚
â”‚    - å¦‚æœæ˜¯å¤šä¸»æœºï¼Œå¯ç”¨å¹¶å‘é‡‡é›†                               â”‚
â”‚    - è°ƒç”¨ PluginExecutor.execute()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚
         â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6ï¸âƒ£-A Job è„šæœ¬   â”‚    â”‚ 6ï¸âƒ£-B Protocol  â”‚
â”‚  SSHPlugin      â”‚    â”‚  Python é‡‡é›†å™¨   â”‚
â”‚  - è¯»å–è„šæœ¬æ–‡ä»¶  â”‚    â”‚  - ç›´æ¥è¿æ¥      â”‚
â”‚  - NATS æ‰§è¡Œ    â”‚    â”‚  - æŸ¥è¯¢æ•°æ®      â”‚
â”‚  - è¿”å› JSON    â”‚    â”‚  - è¿”å›å­—å…¸      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7ï¸âƒ£ ç»“æœå¤„ç†                                                  â”‚
â”‚    - åˆå¹¶å¤šä¸»æœºæ•°æ®                                           â”‚
â”‚    - è½¬æ¢ä¸º Prometheus æ ¼å¼                                   â”‚
â”‚    - æ¨é€åˆ° NATS æ¶ˆæ¯é˜Ÿåˆ—                                     â”‚
â”‚    - æœ€ç»ˆè¢« Telegraf é‡‡é›†                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æµç¨‹è¯´æ˜

#### 1. è¯·æ±‚æ¥æ”¶é˜¶æ®µ

**æ–‡ä»¶ï¼š** [api/collect.py](../api/collect.py)

```python
# å‚æ•°è§£æï¼šä» Headers ä¸­æå– cmdb* å‚æ•°
params = {k.split("cmdb", 1)[-1]: v 
          for k, v in dict(request.headers).items() 
          if k.startswith("cmdb")}

# æå–æ ‡ç­¾
instance_id = request.headers.get("instance_id")
model_id = params.get("model_id")

# åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—
task_queue = get_task_queue()
task_info = await task_queue.enqueue_collect_task(task_params)

# ç«‹å³è¿”å›"å·²æ¥æ”¶"å“åº”
return response.raw(metrics_response, content_type='text/plain; ...')
```

#### 2. ä»»åŠ¡è°ƒåº¦é˜¶æ®µ

**æ–‡ä»¶ï¼š** [core/worker.py](../core/worker.py)

```python
async def collect_task(ctx, params, task_id):
    """ARQ Worker å…¥å£å‡½æ•°"""
    plugin_name = params.get("plugin_name")
    
    # åˆ†å‘åˆ°æ’ä»¶å¤„ç†å™¨
    if plugin_name:
        from tasks.handlers.plugin_handler import collect_plugin_task
        return await collect_plugin_task(ctx, params, task_id)
```

#### 3. æ’ä»¶æ‰§è¡Œé˜¶æ®µ

**æ–‡ä»¶ï¼š** [core/plugin_executor.py](../core/plugin_executor.py)

```python
async def execute(self):
    """ç»Ÿä¸€çš„æ‰§è¡Œæµç¨‹"""
    # 1. è¯»å– YAML é…ç½®
    collector_info = self.executor_config.get_collector_info()
    
    # 2. åŠ¨æ€åŠ è½½é‡‡é›†å™¨ç±»
    collector_class = self._load_collector(
        collector_info['module'], 
        collector_info['class']
    )
    
    # 3. å®ä¾‹åŒ–é‡‡é›†å™¨
    collector_instance = collector_class(self.params)
    
    # 4. æ‰§è¡Œé‡‡é›†
    result = await collector_instance.list_all_resources()
    
    return result
```

---

## æ’ä»¶å¼€å‘å¿«é€Ÿä¸Šæ‰‹

### æ’ä»¶ç›®å½•ç»“æ„

æ‰€æœ‰æ’ä»¶éƒ½ä½äº `plugins/inputs/` ç›®å½•ä¸‹ï¼š

```
plugins/inputs/
â”œâ”€â”€ mysql/                    # MySQL æ’ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ plugin.yml           # é…ç½®æ–‡ä»¶ â­
â”‚   â””â”€â”€ mysql_info.py        # Python é‡‡é›†å™¨
â”œâ”€â”€ redis/                    # Redis æ’ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ plugin.yml           # é…ç½®æ–‡ä»¶ â­
â”‚   â””â”€â”€ redis_default_discover.sh  # Shell è„šæœ¬
â”œâ”€â”€ oracle/                   # Oracle æ’ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ plugin.yml
â”‚   â””â”€â”€ oracle_info.py
â””â”€â”€ your_plugin/              # ä½ çš„æ–°æ’ä»¶
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ plugin.yml           # â­ å¿…éœ€
    â””â”€â”€ your_script.sh æˆ– your_collector.py
```

### æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | æ˜¯å¦å¿…éœ€ | ä½œç”¨ |
|------|---------|------|
| `__init__.py` | âœ… å¿…éœ€ | Python åŒ…æ ‡è¯†æ–‡ä»¶ï¼ˆå¯ä¸ºç©ºï¼‰ |
| `plugin.yml` | âœ… å¿…éœ€ | æ’ä»¶é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰æ‰§è¡Œå™¨ã€è„šæœ¬è·¯å¾„ç­‰ |
| `xxx_info.py` | Protocol æ–¹å¼éœ€è¦ | Python é‡‡é›†å™¨ç±» |
| `xxx_discover.sh` | Job æ–¹å¼éœ€è¦ | Shell é‡‡é›†è„šæœ¬ |

---

## æ•°æ®æ ¼å¼è§„èŒƒ

> âš ï¸ **é‡è¦**ï¼šæ— è®ºä½¿ç”¨ Job è¿˜æ˜¯ Protocol æ–¹å¼ï¼Œè¿”å›çš„æ•°æ®æ ¼å¼å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹è§„èŒƒï¼Œå¦åˆ™ä¼šå¯¼è‡´é‡‡é›†å¤±è´¥ã€‚

### æˆåŠŸè¿”å›æ ¼å¼

#### æ ‡å‡†æ•°æ®ç»“æ„

æ‰€æœ‰é‡‡é›†å™¨ï¼ˆShell è„šæœ¬æˆ– Python ç±»ï¼‰éƒ½å¿…é¡»è¿”å›ä»¥ä¸‹æ ¼å¼ï¼š

```json
{
  "result": {
    "æ¨¡å‹å": [
      {
        "å­—æ®µ1": "å€¼1",
        "å­—æ®µ2": 123,
        "å­—æ®µ3": true,
        ...
      }
    ]
  },
  "success": true
}
```

#### å­—æ®µè¯´æ˜

| å­—æ®µè·¯å¾„ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|---------|------|------|------|
| `result` | Object | âœ… å¿…éœ€ | ç»“æœå¯¹è±¡ï¼ŒåŒ…å«æ¨¡å‹æ•°æ® |
| `result.{æ¨¡å‹å}` | Array | âœ… å¿…éœ€ | æ¨¡å‹æ•°æ®æ•°ç»„ï¼Œæ¨¡å‹åé€šå¸¸ä¸ model_id ä¸€è‡´ï¼ˆå¦‚ï¼šmysqlã€oracleã€redisï¼‰ |
| `result.{æ¨¡å‹å}[]` | Object | âœ… å¿…éœ€ | å®ä¾‹æ•°æ®å¯¹è±¡ï¼ŒåŒ…å«å…·ä½“çš„é‡‡é›†å­—æ®µ |
| `success` | Boolean | âœ… å¿…éœ€ | é‡‡é›†æ˜¯å¦æˆåŠŸï¼Œtrue è¡¨ç¤ºæˆåŠŸï¼Œfalse è¡¨ç¤ºå¤±è´¥ |

#### å‘½åè§„èŒƒ

1. **æ¨¡å‹åè§„èŒƒï¼š** é€šå¸¸ä¸ `plugin.yml` ä¸­çš„ `model_id` ä¿æŒä¸€è‡´
   ```
   âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
   - "mysql"
   - "oracle"
   - "redis"
   - "nginx"
   
   âŒ é”™è¯¯ç¤ºä¾‹ï¼š
   - "MySQL"ï¼ˆåº”ä½¿ç”¨å°å†™ï¼‰
   - "my_sql"ï¼ˆåº”ä¸é…ç½®æ–‡ä»¶ä¸€è‡´ï¼‰
   ```

2. **å­—æ®µå‘½åé£æ ¼ï¼š** ä½¿ç”¨ `snake_case`ï¼ˆå°å†™ä¸‹åˆ’çº¿ï¼‰
   ```json
   âœ… æ­£ç¡®ï¼š
   {
     "ip_addr": "192.168.1.100",
     "max_conn": 1000,
     "enable_binlog": "ON"
   }
   
   âŒ é”™è¯¯ï¼š
   {
     "IpAddr": "192.168.1.100",
     "maxConn": 1000
   }
   ```

3. **å¸¸è§å­—æ®µçº¦å®šï¼š**
   - `ip_addr`ï¼šIP åœ°å€
   - `port`ï¼šç«¯å£å·
   - `version`ï¼šç‰ˆæœ¬å·
   - å…¶ä»–å­—æ®µæ ¹æ®ä¸šåŠ¡éœ€æ±‚è‡ªå®šä¹‰

#### æ•°æ®ç±»å‹æ”¯æŒ

| ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|
| String | `"8.0.28"` | å­—ç¬¦ä¸²ç±»å‹ |
| Integer | `3306` | æ•´æ•°ç±»å‹ |
| Float | `99.5` | æµ®ç‚¹æ•°ç±»å‹ |
| Boolean | `true` / `false` | å¸ƒå°”ç±»å‹ï¼ˆPython ä¸­ä½¿ç”¨ True/Falseï¼‰ |
| Array | `[1, 2, 3]` | æ•°ç»„ç±»å‹ |
| Object | `{"key": "value"}` | å¯¹è±¡ç±»å‹ |
| Null | `null` | ç©ºå€¼ |

### æˆåŠŸè¿”å›ç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šMySQL å•å®ä¾‹

```json
{
  "result": {
    "mysql": [
      {
        "ip_addr": "192.168.1.100",
        "port": 3306,
        "version": "8.0.28",
        "enable_binlog": "ON",
        "sync_binlog": "1",
        "max_conn": "1000",
        "max_mem": "67108864",
        "basedir": "/usr/",
        "datadir": "/var/lib/mysql/",
        "socket": "/var/run/mysqld/mysqld.sock",
        "bind_address": "0.0.0.0",
        "slow_query_log": "ON",
        "slow_query_log_file": "/var/log/mysql/slow.log",
        "log_error": "/var/log/mysql/error.log",
        "wait_timeout": "28800"
      }
    ]
  },
  "success": true
}
```

#### ç¤ºä¾‹ 2ï¼šOracle å•å®ä¾‹

```json
{
  "result": {
    "oracle": [
      {
        "ip_addr": "192.168.1.200",
        "port": 1521,
        "version": "Oracle Database 19c Enterprise Edition",
        "max_mem": "2147483648",
        "max_conn": "300",
        "db_name": "ORCL",
        "database_role": "PRIMARY",
        "sid": "orcl",
        "service_name": "orclpdb",
        "inst_name": "192.168.1.200-oracle"
      }
    ]
  },
  "success": true
}
```

#### ç¤ºä¾‹ 3ï¼šåŒ…å«å¤šä¸ªå®ä¾‹ï¼ˆå‡è®¾åœºæ™¯ï¼‰

```json
{
  "result": {
    "redis": [
      {
        "ip_addr": "192.168.1.100",
        "port": 6379,
        "version": "6.2.6",
        "role": "master",
        "used_memory": 1048576,
        "connected_clients": 10
      },
      {
        "ip_addr": "192.168.1.100",
        "port": 6380,
        "version": "6.2.6",
        "role": "slave",
        "used_memory": 524288,
        "connected_clients": 5
      }
    ]
  },
  "success": true
}
```

### å¤±è´¥è¿”å›æ ¼å¼

#### å¤±è´¥æ•°æ®ç»“æ„

å½“é‡‡é›†å¤±è´¥æ—¶ï¼Œå¿…é¡»è¿”å›ä»¥ä¸‹æ ¼å¼ï¼š

```json
{
  "result": {
    "cmdb_collect_error": "å…·ä½“é”™è¯¯ä¿¡æ¯"
  },
  "success": false
}
```

#### å­—æ®µè¯´æ˜

| å­—æ®µè·¯å¾„ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|---------|------|------|------|
| `result.cmdb_collect_error` | String | âœ… å¿…éœ€ | é”™è¯¯ä¿¡æ¯æè¿° |
| `success` | Boolean | âœ… å¿…éœ€ | å¿…é¡»ä¸º false |

#### å¤±è´¥è¿”å›ç¤ºä¾‹

```json
{
  "result": {
    "cmdb_collect_error": "Failed to connect to MySQL: Connection refused"
  },
  "success": false
}
```

### å¤±è´¥å¤„ç†è§„èŒƒ

#### Python é‡‡é›†å™¨å¤±è´¥å¤„ç†ï¼ˆæ¨èæ–¹å¼ï¼‰

```python
class MysqlInfo:
    def list_all_resources(self):
        try:
            self._connect()
            self._collect()
            
            # æ„å»ºæˆåŠŸè¿”å›æ•°æ®
            model_data = {
                "ip_addr": self.host,
                "port": self.port,
                "version": self.info['version']['version'],
                # ... å…¶ä»–å­—æ®µ
            }
            inst_data = {
                "result": {"mysql": [model_data]}, 
                "success": True
            }
            
        except Exception as err:
            import traceback
            logger.error(f"mysql_info main error! {traceback.format_exc()}")
            # è¿”å›é”™è¯¯æ ¼å¼
            inst_data = {
                "result": {"cmdb_collect_error": str(err)}, 
                "success": False
            }
            
        finally:
            self.close()
            
        return inst_data
```

#### Shell è„šæœ¬å¤±è´¥å¤„ç†

**æ–¹å¼ 1ï¼šè¿”å›ç©ºæ•°æ®åˆ—è¡¨ï¼ˆæ¨èï¼‰**

```bash
#!/bin/bash

discover_service() {
    # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
    if ! pgrep -f "redis-server" > /dev/null; then
        # æ²¡æœ‰å‘ç°æœåŠ¡ï¼Œè¿”å›ç©ºæ•°æ®ä½†æ ‡è®°æˆåŠŸ
        echo '{"result":{"redis":[]},"success":true}'
        return 0
    fi
    
    # æ­£å¸¸é‡‡é›†é€»è¾‘
    # ...
}

discover_service
```

**æ–¹å¼ 2ï¼šè¿”å›é”™è¯¯ä¿¡æ¯**

```bash
#!/binè¿”å›çš„ JSON æ•°æ®è½¬æ¢ä¸º Prometheus æ ¼å¼ï¼š

#### è½¬æ¢è§„åˆ™

```
è¾“å…¥ JSONï¼š
{
  "result": {
    "mysql": [
      {
        "ip_addr": "192.168.1.100",
        "port": 3306,
        "version": "8.0.28",
        "max_conn": "1000",
        "enable_binlog": "ON"
      }
    ]
  },
  "success": true
}

è¾“å‡º Prometheusï¼ˆç¤ºä¾‹ï¼‰ï¼š
```angular2html
# HELP mysql_port MySQL port
# TYPE mysql_port gauge
mysql_port{ip_addr="192.168.1.100",version="8.0.28"} 3306

# HELP mysql_max_conn MySQL max connections
# TYPE mysql_max_conn gauge
mysql_max_conn{ip_addr="192.168.1.100",version="8.0.28"} 1000

# HELP mysql_enable_binlog MySQL binlog enabled
# TYPE mysql_enable_binlog gauge
mysql_enable_binlog{ip_addr="192.168.1.100",version="8.0.28",enable_binlog="ON"} 

```

#### å­—æ®µç±»å‹è½¬æ¢

| æ•°æ®ç±»å‹ | Prometheus å¤„ç† | ç¤ºä¾‹ |
|---------|----------------|------|
| Numberï¼ˆæ•°å­—ï¼‰ | ä½œä¸ºæŒ‡æ ‡å€¼ | `port: 3306` â†’ `mysql_port{...} 3306` |
| Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ | ä½œä¸ºæ ‡ç­¾ï¼ˆlabelï¼‰ | `version: "8.0.28"` â†’ æ ‡ç­¾ `version="8.0.28"` |
| Booleanï¼ˆå¸ƒå°”ï¼‰ | è½¬æ¢ä¸º 0/1 | `True` â†’ `1`, `False` â†’ `0` |
| Arrayï¼ˆæ•°ç»„ï¼‰ | å±•å¼€ä¸ºå¤šä¸ªæŒ‡æ ‡ | æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ ç”Ÿæˆä¸€ä¸ªæŒ‡æ ‡ |
| Objectï¼ˆå¯¹è±¡ï¼‰ | å±•å¼€ä¸ºå¤šä¸ªæŒ‡æ ‡ | å¯¹è±¡ä¸­æ¯ä¸ªå­—æ®µç”Ÿæˆä¸€ä¸ªæŒ‡æ ‡ |
| Nullï¼ˆç©ºå€¼ï¼‰ | è·³è¿‡è¯¥å­—æ®µ | ä¸ç”ŸæˆæŒ‡æ ‡nections": 1000
    }
  ]
}

è¾“å‡º Prometheusï¼š
```angular2html

# HELP mysql_port MySQL port
# TYPE mysql_port gauge
mysql_port{instance="mysql-3306",bk_host_innerip="192.168.1.100"} 3306

# HELP mysql_version MySQL version
# TYPE mysql_version gauge
mysql_version{instance="mysql-3306",bk_host_innerip="192.168.1.100",version="8.0.28"} 1

# HELP mysql_max_connections MySQL max connections
# TYPE mysql_max_connections gauge
mysql_max_connections{instance="mysql-3306",bk_host_innerip="192.168.1.100"} 1000

```


#### å­—æ®µç±»å‹è½¬æ¢

| JSON ç±»å‹ | Prometheus å¤„ç† |
|-----------|----------------|
| Number | ä½œä¸ºæŒ‡æ ‡å€¼ |
| String | ä½œä¸ºæ ‡ç­¾ï¼ˆlabelï¼‰ |
| Boolean | è½¬æ¢ä¸º 0/1 |
| Array | å±•å¼€ä¸ºå¤šä¸ªæŒ‡æ ‡ |
| Object | å±•å¼€ä¸ºå¤šä¸ªæŒ‡æ ‡ |
| Null | è·³è¿‡è¯¥å­—æ®µ |

### å¸¸è§é”™è¯¯ä¸è§£å†³

#### é”™è¯¯ 1ï¼šç¼ºå°‘å¿…éœ€å­—æ®µ

```result": {
    "mysql": [{"port": 3306}]
  }
  // ç¼ºå°‘ success å­—æ®µ
}

âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
{
  "result": {
    "mysql": [{"port": 3306, "ip_addr": "192.168.1.100"}]
  },
  "success": true
}
```

#### é”™è¯¯ 2ï¼šæ¨¡å‹åä¸ä¸€è‡´

```json
âŒ é”™è¯¯ç¤ºä¾‹ï¼š
{
  "result": {
    "MySQL": [...]  // æ¨¡å‹åå¤§å†™
  },
  "success": true
}

âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
{
  "result": {
    "mysql": [...]  // ä¸ plugin.yml ä¸­çš„ model_id ä¸€è‡´
  },
  "success": true
}
```

#### é”™è¯¯ 3ï¼šå¤±è´¥æ—¶è¿”å›æ ¼å¼é”™è¯¯

```python
âŒ é”™è¯¯ç¤ºä¾‹ï¼š
# å¤±è´¥æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸è€Œä¸æ•è·
def list_all_resources(self):
    self._connect()  # å¦‚æœè¿æ¥å¤±è´¥ï¼Œç›´æ¥æŠ›å¼‚å¸¸
    return {"result": {"mysql": [...]}, "success": True}

âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
def list_all_resources(self):
    try:
        self._connect()
        return {"result": {"mysql": [...]}, "success": True}
    except Exception as e:
        return {"result": {"cmdb_collect_error": str(e)}, "success": False}
```

#### é”™è¯¯ 4ï¼šJSON æ ¼å¼é”™è¯¯ï¼ˆShell è„šæœ¬ï¼‰

```bash
âŒ Shell è„šæœ¬é”™è¯¯ï¼š
# æœ«å°¾å¤šäº†é€—å·
echo '{"result":{"redis":[]},"success":true,}'

âœ… æ­£ç¡®ï¼š
echo '{"result":{"redis":[]},"success":true}'
```

#### é”™è¯¯ 5ï¼šæ•°æ®ç±»å‹ä½¿ç”¨é”™è¯¯

```python
âŒ é”™è¯¯ç¤ºä¾‹ï¼š
{
  "result": {
    "mysql": [
      {
        "port": "3306",  # åº”è¯¥æ˜¯æ•°å­—
        "max_conn": 1000  # æŸäº›å­—æ®µå¯èƒ½éœ€è¦å­—ç¬¦ä¸²
      }
    ]
  },
  "success": true
}

âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆå‚è€ƒç°æœ‰æ’ä»¶ï¼‰ï¼š
{
  "result": {
    "mysql": [
      {
        "port": 3306,      # æ•°å­—ç±»å‹
        "max_conn": "1000" # å­—ç¬¦ä¸²ç±»å‹ï¼ˆå–å†³äºæ•°æ®åº“è¿”å›ï¼‰
      }
    ]
  },
  "success": true
}
```

### æ•°æ®éªŒè¯æ¸…å•

å¼€å‘å®Œæˆåï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] âœ… åŒ…å« `result` å¯¹è±¡
- [ ] âœ… `result` ä¸­åŒ…å«æ¨¡å‹åä½œä¸º keyï¼ˆä¸ model_id ä¸€è‡´ï¼‰
- [ ] âœ… æ¨¡å‹æ•°æ®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆå³ä½¿åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰
- [ ] âœ… åŒ…å« `success` å­—æ®µï¼ˆboolean ç±»å‹ï¼‰
- [ ] âœ… æˆåŠŸæ—¶ `success: true`ï¼Œå¤±è´¥æ—¶ `success: false`
- [ ] âœ… å¤±è´¥æ—¶ä½¿ç”¨ `cmdb_collect_error` ä½œä¸ºé”™è¯¯key
- [ ] âœ… å­—æ®µå‘½åä½¿ç”¨ `snake_case`ï¼ˆå°å†™ä¸‹åˆ’çº¿ï¼‰
- [ ] âœ… æ•°å­—å­—æ®µæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹© int æˆ– str ç±»å‹
- [ ] âœ… JSON æ ¼å¼æœ‰æ•ˆï¼ˆå¯é€šè¿‡ `python -m json.tool` éªŒè¯ï¼‰
- [ ] âœ… Python å¼‚å¸¸å·²è¢«æ•è·å¹¶æ­£ç¡®è¿”å›é”™è¯¯æ ¼å¼
- [ ] âœ… Shell è„šæœ¬è¾“å‡ºçš„ JSON æ²¡æœ‰é¢å¤–çš„è°ƒè¯•ä¿¡æ¯
- [ ] âœ… JSON æ ¼å¼æœ‰æ•ˆï¼ˆå¯é€šè¿‡ `python -m json.tool` éªŒè¯ï¼‰
- [ ] âœ… Shell è„šæœ¬è¾“å‡ºçš„ JSON æ²¡æœ‰é¢å¤–çš„è°ƒè¯•ä¿¡æ¯
- [ ] âœ… å¼‚å¸¸æƒ…å†µæ­£ç¡®å¤„ç†ï¼ˆæŠ›å‡ºå¼‚å¸¸æˆ–è¿”å›ç©º dataï¼‰

---

## ä¸¤ç§é‡‡é›†æ–¹å¼è¯¦è§£

### æ–¹å¼ä¸€ï¼šJobï¼ˆè„šæœ¬é‡‡é›†ï¼‰

é€‚ç”¨åœºæ™¯ï¼šé€šè¿‡ SSH æ‰§è¡Œ Shell è„šæœ¬è¿›è¡Œæ•°æ®é‡‡é›†

#### plugin.yml é…ç½®ç¤ºä¾‹

**æ–‡ä»¶ä½ç½®ï¼š** `plugins/inputs/redis/plugin.yml`

```yaml
name: redis
version: "2.0.0"
category: database

metadata:
  display_name: "Redis æ•°æ®åº“"
  description: "Redis æ•°æ®åº“é‡‡é›†æ’ä»¶ï¼Œæ”¯æŒè„šæœ¬æ–¹å¼é‡‡é›†"
  author: "WeOps"
  tags: [database, redis, cache]
  cloud_protocol: false
  model_id: redis

# ============================================================================
# æ‰§è¡Œå™¨é…ç½®
# ============================================================================
executors:
  # Job ç±»å‹ï¼ˆè„šæœ¬é‡‡é›†ï¼‰
  job:
    type: job
    timeout: 60

    # ä¸åŒæ“ä½œç³»ç»Ÿçš„è„šæœ¬
    scripts:
      linux: plugins/inputs/redis/redis_default_discover.sh
      # windows: plugins/inputs/redis/redis_discover.ps1  # å¯é€‰

    # é‡‡é›†å™¨ç±»ï¼ˆå›ºå®šä½¿ç”¨ SSHPluginï¼‰
    collector:
      module: plugins.script_executor
      class: SSHPlugin

    # é»˜è®¤è„šæœ¬
    default_script: linux

# é»˜è®¤æ‰§è¡Œå™¨
default_executor: job
```

#### Shell è„šæœ¬ç¼–å†™è§„èŒƒ

**æ–‡ä»¶ä½ç½®ï¼š** `plugins/inputs/redis/redis_default_discover.sh`

**é‡è¦è§„èŒƒï¼š**

1. **è„šæœ¬å¿…é¡»è¿”å› JSON æ ¼å¼æ•°æ®**
2. **JSON æ ¼å¼å¿…é¡»ç¬¦åˆä»¥ä¸‹ç»“æ„ï¼š**

```json
{
  "result": {
    "redis": [
      {
        "ip_addr": "192.168.1.100",
        "port": 6379,
        "version": "6.2.6",
        "role": "master"
      }
    ]
  },
  "success": true
}
```

**è„šæœ¬ç¤ºä¾‹ç‰‡æ®µï¼š**

```bash
#!/bin/bash

# å‘ç° Redis è¿›ç¨‹
discover_redis() {
    local procs=($(_procs))
    
    # è·å–ä¸»æœº IP
    local host_ip=$(hostname -I | awk '{print $1}')
    
    # æ„å»º JSON
    local json_output='{"result":{"redis":['
    
    for proc in "${procs[@]}"; do
        local port=$(echo $proc | cut -d: -f3)
        local version=$(get_redis_info "$port" "redis_version")
        local role=$(get_redis_info "$port" "role")
        
        # æ·»åŠ å®ä¾‹æ•°æ®
        json_output+='{"ip_addr":"'$host_ip'","port":'$port',"version":"'$version'","role":"'$role'"},'
    done
    
    # ç§»é™¤æœ«å°¾é€—å·å¹¶é—­åˆ JSON
    json_output="${json_output%,}]},"success":true}"
    echo "$json_output"
}

# æ‰§è¡Œå¹¶è¾“å‡º
discover_redis
```

#### è„šæœ¬æ”¾ç½®ä½ç½®

```
plugins/inputs/{model_id}/
    â”œâ”€â”€ plugin.yml
    â””â”€â”€ {model_id}_default_discover.sh    # è„šæœ¬æ–‡ä»¶

# ä¾‹å¦‚ï¼š
plugins/inputs/redis/
    â”œâ”€â”€ plugin.yml
    â””â”€â”€ redis_default_discover.sh
```

#### æ‰§è¡Œæµç¨‹

```
1. PluginExecutor è¯»å– plugin.yml
   â†“
2. ç¡®å®šè„šæœ¬è·¯å¾„ï¼šplugins/inputs/redis/redis_default_discover.sh
   â†“
3. SSHPlugin è¯»å–è„šæœ¬å†…å®¹
   â†“
4. é€šè¿‡ NATS å‘é€åˆ°ç›®æ ‡ä¸»æœºæ‰§è¡Œ
   â†“
5. æ¥æ”¶ JSON ç»“æœ
   â†“
6. è½¬æ¢ä¸º Prometheus æ ¼å¼
```

---

### æ–¹å¼äºŒï¼šProtocolï¼ˆåè®®é‡‡é›†ï¼‰

é€‚ç”¨åœºæ™¯ï¼šç›´æ¥é€šè¿‡ç½‘ç»œåè®®ï¼ˆMySQLã€Oracleã€Redis ç­‰ï¼‰è¿æ¥å¹¶é‡‡é›†æ•°æ®

#### plugin.yml é…ç½®ç¤ºä¾‹

**æ–‡ä»¶ä½ç½®ï¼š** `plugins/inputs/mysql/plugin.yml`

```yaml
name: mysql
version: "2.0.0"
category: database

metadata:
  display_name: "MySQL æ•°æ®åº“"
  description: "MySQL æ•°æ®åº“é‡‡é›†æ’ä»¶ï¼Œæ”¯æŒåè®®é‡‡é›†"
  author: "WeOps"
  tags: [database, mysql]
  cloud_protocol: false
  model_id: mysql

# ============================================================================
# æ‰§è¡Œå™¨é…ç½®
# ============================================================================
executors:
  # Protocol ç±»å‹ï¼ˆåè®®é‡‡é›†ï¼‰
  protocol:
    type: protocol
    timeout: 30

    # Python é‡‡é›†å™¨
    collector:
      module: plugins.inputs.mysql.mysql_info
      class: MysqlInfo

# é»˜è®¤æ‰§è¡Œå™¨
default_executor: protocol
```

#### Python é‡‡é›†å™¨ç¼–å†™è§„èŒƒ

**æ–‡ä»¶ä½ç½®ï¼š** `plugins/inputs/mysql/mysql_info.py`

**é‡è¦è§„èŒƒï¼š**

1. **ç±»åå¿…é¡»ä¸ plugin.yml ä¸­ `collector.class` ä¸€è‡´**
2. **å¿…é¡»å®ç° `list_all_resources()` æ–¹æ³•**
3. **è¿”å›æ ¼å¼å¿…é¡»æ˜¯å­—å…¸ï¼ŒåŒ…å« `metadata` å’Œ `data`**

**å®Œæ•´ç¤ºä¾‹ï¼š**

```python
#!/usr/bin/python
# -*- coding: utf-8 -*-
"""
MySQL ä¿¡æ¯é‡‡é›†å™¨
"""
import pymysql
from sanic.log import logger


class MysqlInfo:
    """MySQL å®ä¾‹ä¿¡æ¯é‡‡é›†å™¨"""

    def __init__(self, kwargs):
        """
        åˆå§‹åŒ–é‡‡é›†å™¨
        
        Args:
            kwargs: é‡‡é›†å‚æ•°å­—å…¸
                - host: æ•°æ®åº“ä¸»æœºåœ°å€
                - port: ç«¯å£
                - user: ç”¨æˆ·å
                - password: å¯†ç 
        """
        self.host = kwargs.get('host', 'localhost')
        self.port = int(kwargs.get('port', 3306))
        self.user = kwargs.get('user')
        self.password = kwargs.get('password', '')
        self.connection = None
        self.cursor = None

    def _connect(self):
        """å»ºç«‹æ•°æ®åº“è¿æ¥"""
        try:
            self.connection = pymysql.connect(
                host=self.host,
                port=self.port,
                user=self.user,
                password=self.password,
                cursorclass=pymysql.cursors.DictCursor,
            )
            self.cursor = self.connection.cursor()
            logger.info(f"Connected to MySQL: {self.host}:{self.port}")
        except Exception as e:
            raise RuntimeError(f"Failed to connect to MySQL: {str(e)}")

    def _exec_sql(self, query):
        """æ‰§è¡ŒSQLæŸ¥è¯¢"""
        try:
            self.cursor.execute(query)
            return self.cursor.fetchall()
        except Exception as e:
            raise RuntimeError(f"Error executing SQL: {str(e)}")

    def _get_version(self):
        """è·å–MySQLç‰ˆæœ¬"""
        result = self._exec_sql("SELECT VERSION() as version")
        return result[0]['version'] if result else "Unknown"

    def _get_databases(self):
        """è·å–æ•°æ®åº“åˆ—è¡¨åŠå¤§å°"""
        query = '''
            SELECT table_schema AS name,
                   SUM(data_length + index_length) AS size
            FROM information_schema.TABLES 
            GROUP BY table_schema
        '''
        return self._exec_sql(query)

    def list_all_resources(self):
        """
        ä¸»é‡‡é›†æ–¹æ³• - å¿…é¡»å®ç°
        
        Returns:
            dict: é‡‡é›†ç»“æœ
            {
                "result": {
                    "mysql": [
                        {
                            "ip_addr": "192.168.1.100",
                            "port": 3306,
                            "version": "8.0.28",
                            ...
                        }
                    ]
                },
                "success": True
            }
        """
        try:
            # 1. å»ºç«‹è¿æ¥
            self._connect()

            # 2. é‡‡é›†æ•°æ®
            version = self._get_version()
            databases = self._get_databases()

            # 3. æ„å»ºè¿”å›ç»“æœ
            model_data = {
                "ip_addr": self.host,
                "port": self.port,
                "version": version,
                "max_conn": "1000",
                "database_list": [
                    {
                        "name": db['name'],
                        "size": int(db['size']) if db['size'] else 0
                    }
                    for db in databases
                ]
            }
            
            result = {
                "result": {"mysql": [model_data]},
                "success": True
            }

            logger.info(f"MySQL collection completed: {self.host}:{self.port}")
            return result

        except Exception as e:
            logger.error(f"MySQL collection failed: {str(e)}")
            # è¿”å›é”™è¯¯æ ¼å¼
            return {
                "result": {"cmdb_collect_error": str(e)},
                "success": False
            }

        finally:
            # 4. å…³é—­è¿æ¥
            if self.connection:
                self.connection.close()
```

#### é‡‡é›†å™¨æ”¾ç½®ä½ç½®

```
plugins/inputs/{model_id}/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ plugin.yml
    â””â”€â”€ {model_id}_info.py    # Python é‡‡é›†å™¨

# ä¾‹å¦‚ï¼š
plugins/inputs/mysql/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ plugin.yml
    â””â”€â”€ mysql_info.py
```

#### æ‰§è¡Œæµç¨‹

```
1. PluginExecutor è¯»å– plugin.yml
   â†“
2. åŠ¨æ€å¯¼å…¥æ¨¡å—ï¼šplugins.inputs.mysql.mysql_info
   â†“
3. å®ä¾‹åŒ–ç±»ï¼šMysqlInfo(params)
   â†“
4. è°ƒç”¨ï¼šlist_all_resources()
   â†“
5. è¿”å›å­—å…¸ç»“æœ
   â†“
6. è½¬æ¢ä¸º Prometheus æ ¼å¼
```

---

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåˆ›å»ºä¸€ä¸ª Redis Job æ’ä»¶

#### ç¬¬ 1 æ­¥ï¼šåˆ›å»ºç›®å½•

```bash
mkdir -p plugins/inputs/redis
touch plugins/inputs/redis/__init__.py
```

#### ç¬¬ 2 æ­¥ï¼šç¼–å†™ plugin.yml

**æ–‡ä»¶ï¼š** `plugins/inputs/redis/plugin.yml`

```yaml
name: redis
version: "2.0.0"
category: database

metadata:
  display_name: "Redis æ•°æ®åº“"
  description: "Redis é‡‡é›†æ’ä»¶"
  author: "Your Name"
  tags: [database, redis]
  cloud_protocol: false
  model_id: redis

executors:
  job:
    type: job
    timeout: 60
    scripts:
      linux: plugins/inputs/redis/redis_default_discover.sh
    collector:
      module: plugins.script_executor
      class: SSHPlugin
    default_script: linux

default_executor: job
```

#### ç¬¬ 3 æ­¥ï¼šç¼–å†™ Shell è„šæœ¬

**æ–‡ä»¶ï¼š** `plugins/inputs/redis/redis_default_discover.sh`

```bash
#!/bin/bash

# è·å– Redis è¿›ç¨‹
get_redis_processes() {
    ps -ef | grep redis-server | grep -v grep
}

# è§£æç«¯å£å’Œç‰ˆæœ¬
discover_redis() {
    local host_ip=$(hostname -I | awk '{print $1}')
    local json_data='{"result":{"redis":['
    local first=true
    
    while read -r line; do
        # æå–ç«¯å£å·
        local port=$(echo "$line" | grep -oP ':\d+' | head -1 | tr -d ':')
        
        if [ -n "$port" ]; then
            # è·å– Redis ç‰ˆæœ¬
            local version=$(redis-cli -p "$port" INFO server 2>/dev/null | grep redis_version | cut -d: -f2 | tr -d '\r')
            
            # æ·»åŠ é€—å·åˆ†éš”ç¬¦ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰
            if [ "$first" = false ]; then
                json_data+=','
            fi
            first=false
            
            # æ·»åŠ å®ä¾‹ä¿¡æ¯
            json_data+='{"ip_addr":"'$host_ip'","port":'$port',"version":"'${version:-unknown}'"}'
        fi
    done < <(get_redis_processes)
    
    # é—­åˆ JSON
    json_data+='],"success":true}'
    echo "$json_data"
}

# æ‰§è¡Œé‡‡é›†
discover_redis
```

#### ç¬¬ 4 æ­¥ï¼šæµ‹è¯•

```bash
# æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬æµ‹è¯•
bash plugins/inputs/redis/redis_default_discover.sh

# é¢„æœŸè¾“å‡ºï¼ˆJSONï¼‰ï¼š
# {"result":{"redis":[{"ip_addr":"192.168.1.100","port":6379,"version":"6.2.6"}]},"success":true}

# éªŒè¯ JSON æ ¼å¼
bash plugins/inputs/redis/redis_default_discover.sh | python -m json.tool
```

---

### ç¤ºä¾‹ 2ï¼šåˆ›å»ºä¸€ä¸ª PostgreSQL Protocol æ’ä»¶

#### ç¬¬ 1 æ­¥ï¼šåˆ›å»ºç›®å½•

```bash
mkdir -p plugins/inputs/pgsql
touch plugins/inputs/pgsql/__init__.py
```

#### ç¬¬ 2 æ­¥ï¼šç¼–å†™ plugin.yml

**æ–‡ä»¶ï¼š** `plugins/inputs/pgsql/plugin.yml`

```yaml
name: pgsql
version: "1.0.0"
category: database

metadata:
  display_name: "PostgreSQL æ•°æ®åº“"
  description: "PostgreSQL é‡‡é›†æ’ä»¶"
  author: "Your Name"
  tags: [database, postgresql]
  cloud_protocol: false
  model_id: pgsql

executors:
  protocol:
    type: protocol
    timeout: 30
    collector:
      module: plugins.inputs.pgsql.pgsql_info
      class: PgsqlInfo

default_executor: protocol
```

#### ç¬¬ 3 æ­¥ï¼šç¼–å†™ Python é‡‡é›†å™¨

**æ–‡ä»¶ï¼š** `plugins/inputs/pgsql/pgsql_info.py`

```python
#!/usr/bin/python
# -*- coding: utf-8 -*-
"""
PostgreSQL ä¿¡æ¯é‡‡é›†å™¨
"""
import psycopg2
from sanic.log import logger


class PgsqlInfo:
    """PostgreSQL å®ä¾‹ä¿¡æ¯é‡‡é›†å™¨"""

    def __init__(self, kwargs):
        self.host = kwargs.get('host', 'localhost')
        self.port = int(kwargs.get('port', 5432))
        self.user = kwargs.get('user', 'postgres')
        self.password = kwargs.get('password', '')
        self.database = kwargs.get('database', 'postgres')
        self.connection = None

    def _connect(self):
        """å»ºç«‹æ•°æ®åº“è¿æ¥"""
        try:
            self.connection = psycopg2.connect(
                host=self.host,
                port=self.port,
                user=self.user,
                password=self.password,
                database=self.database
            )
            logger.info(f"Connected to PostgreSQL: {self.host}:{self.port}")
        except Exception as e:
            raise RuntimeError(f"Failed to connect to PostgreSQL: {str(e)}")

    def _get_version(self):
        """è·å– PostgreSQL ç‰ˆæœ¬"""
        cursor = self.connection.cursor()
        cursor.execute("SELECT version()")
        version = cursor.fetchone()[0]
        cursor.close()
        return version

    def _get_databases(self):
        """è·å–æ•°æ®åº“åˆ—è¡¨"""
        cursor = self.connection.cursor()
        cursor.execute("""
            SELECT datname, pg_database_size(datname) as size
            FROM pg_database
            WHERE datistemplate = false
        """)
        databases = cursor.fetchall()
        cursor.close()
        retu# æ„å»ºæ¨¡å‹æ•°æ®
            model_data = {
                "ip_addr": self.host,
                "port": self.port,
                "version": version,
                "database_list": [
                    {"name": db[0], "size": db[1]}
                    for db in databases
                ]
            }
            
            result = {
                "result": {"pgsql": [model_data]},
                "success": True
            }

            logger.info(f"PostgreSQL collection completed")
            return result

        except Exception as e:
            logger.error(f"PostgreSQL collection failed: {str(e)}")
            return {
                "result": {"cmdb_collect_error": str(e)},
                "success": False
            }       ]
                    }
                ]
            }

            logger.info(f"PostgreSQL collection completed")
            return result

        except Exception as e:
            logger.error(f"PostgreSQL collection failed: {str(e)}")
            raise

        finally:
            if self.connection:
                self.connection.close()
```

#### ç¬¬ 4 æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
pip install psycopg2-binary
```

#### ç¬¬ 5 æ­¥ï¼šæµ‹è¯•

```bash
# å¯åŠ¨ Worker
python start_worker.py

# å‘é€æµ‹è¯•è¯·æ±‚
curl -X GET "http://localhost:8083/api/collect/collect_info" \
     -H "cmdbmodel_id: pgsql" \
     -H "cmdbhosts: 192.168.1.100" \
     -H "cmdbport: 5432" \
     -H "cmdbuser: postgres" \
     -H "cmdbpassword: your_password"
```

---

## YAML é…ç½®è¯¦è§£

### å®Œæ•´é…ç½®æ¨¡æ¿

```yaml
# ============================================================================
# åŸºç¡€ä¿¡æ¯
# ============================================================================
name: plugin_name             # æ’ä»¶åç§°ï¼ˆå¿…éœ€ï¼‰
version: "1.0.0"              # ç‰ˆæœ¬å·
category: database            # åˆ†ç±»ï¼šdatabase, middleware, application ç­‰

# ============================================================================
# å…ƒæ•°æ®
# ============================================================================
metadata:
  display_name: "æ˜¾ç¤ºåç§°"     # UI æ˜¾ç¤ºçš„åç§°
  description: "æ’ä»¶æè¿°"      # æ’ä»¶åŠŸèƒ½æè¿°
  author: "ä½œè€…"              # ä½œè€…ä¿¡æ¯
  tags: [tag1, tag2]          # æ ‡ç­¾åˆ—è¡¨
  cloud_protocol: false       # æ˜¯å¦ä¸ºäº‘åè®®é‡‡é›†ï¼ˆVMwareã€é˜¿é‡Œäº‘ç­‰ï¼‰
  model_id: model_name        # æ¨¡å‹ IDï¼ˆå¿…éœ€ï¼Œä¸ç›®å½•åä¸€è‡´ï¼‰

# ============================================================================
# æ‰§è¡Œå™¨é…ç½®
# ============================================================================
executors:
  # Job ç±»å‹ï¼ˆè„šæœ¬é‡‡é›†ï¼‰
  job:
    type: job                 # æ‰§è¡Œå™¨ç±»å‹ï¼šjob
    timeout: 60               # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

    # è„šæœ¬é…ç½®
    scripts:
      linux: plugins/inputs/xxx/xxx_discover.sh      # Linux è„šæœ¬è·¯å¾„
      windows: plugins/inputs/xxx/xxx_discover.ps1   # Windows è„šæœ¬è·¯å¾„ï¼ˆå¯é€‰ï¼‰

    # é‡‡é›†å™¨ç±»ï¼ˆå›ºå®šï¼‰
    collector:
      module: plugins.script_executor
      class: SSHPlugin

    # é»˜è®¤è„šæœ¬ï¼ˆlinux æˆ– windowsï¼‰
    default_script: linux

  # Protocol ç±»å‹ï¼ˆåè®®é‡‡é›†ï¼‰
  protocol:
    type: protocol            # æ‰§è¡Œå™¨ç±»å‹ï¼šprotocol
    timeout: 30               # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

    # Python é‡‡é›†å™¨
    collector:
      module: plugins.inputs.xxx.xxx_info     # Python æ¨¡å—è·¯å¾„
      class: XxxInfo                          # é‡‡é›†å™¨ç±»å

# ============================================================================
# é»˜è®¤æ‰§è¡Œå™¨
# ============================================================================
default_executor: protocol    # job æˆ– protocol
```

### é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|--------|------|------|------|
| `name` | String | âœ… | æ’ä»¶åç§°ï¼Œå»ºè®®ä¸ç›®å½•åä¸€è‡´ |
| `version` | String | âœ… | ç‰ˆæœ¬å·ï¼Œå¦‚ "1.0.0" |
| `category` | String | âœ… | åˆ†ç±»ï¼šdatabase, middleware, application ç­‰ |
| `metadata.model_id` | String | âœ… | æ¨¡å‹ IDï¼Œå¿…é¡»ä¸ç›®å½•åä¸€è‡´ |
| `metadata.cloud_protocol` | Boolean | âŒ | æ˜¯å¦ä¸ºäº‘åè®®ï¼Œé»˜è®¤ false |
| `executors.job.scripts` | Object | Job å¿…éœ€ | è„šæœ¬è·¯å¾„é…ç½® |
| `executors.protocol.collector` | Object | Protocol å¿…éœ€ | Python é‡‡é›†å™¨é…ç½® |
| `default_executor` | String | âœ… | é»˜è®¤æ‰§è¡Œå™¨ï¼šjob æˆ– protocol |

---

## å¸¸è§é—®é¢˜

### Q1: Job å’Œ Protocol æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| å¯¹æ¯”é¡¹ | Jobï¼ˆè„šæœ¬é‡‡é›†ï¼‰ | Protocolï¼ˆåè®®é‡‡é›†ï¼‰ |
|--------|----------------|---------------------|
| **æ‰§è¡Œæ–¹å¼** | é€šè¿‡ SSH æ‰§è¡Œ Shell è„šæœ¬ | Python ç›´æ¥è¿æ¥æ•°æ®åº“/æœåŠ¡ |
| **é€‚ç”¨åœºæ™¯** | éœ€è¦åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤ | è¿œç¨‹è¿æ¥æ•°æ®åº“/API |
| **ä¾èµ–** | ç›®æ ‡ä¸»æœºéœ€è¦éƒ¨ç½² NATS Agent | åªéœ€ç½‘ç»œå¯è¾¾ |
| **æ€§èƒ½** | è¾ƒæ…¢ï¼ˆSSH è¿æ¥ + è„šæœ¬æ‰§è¡Œï¼‰ | è¾ƒå¿«ï¼ˆç›´æ¥åè®®é€šä¿¡ï¼‰ |
| **è·¨å¹³å°** | éœ€è¦ä¸åŒçš„è„šæœ¬ï¼ˆLinux/Windowsï¼‰ | Python è·¨å¹³å° |

**é€‰æ‹©å»ºè®®ï¼š**
- **ä¼˜å…ˆä½¿ç”¨ Protocol**ï¼šæ€§èƒ½æ›´å¥½ï¼Œç»´æŠ¤æ›´ç®€å•
- **ä½¿ç”¨ Job çš„åœºæ™¯**ï¼šéœ€è¦åœ¨ç›®æ ‡ä¸»æœºæ‰§è¡Œæœ¬åœ°å‘½ä»¤ï¼ˆå¦‚æŸ¥çœ‹è¿›ç¨‹ã€æ–‡ä»¶ç­‰ï¼‰

---

### Q2: å¦‚ä½•æ”¯æŒå¤šæ“ä½œç³»ç»Ÿï¼Ÿ

#### Job æ–¹å¼ï¼š
åœ¨ `plugin.yml` ä¸­é…ç½®å¤šä¸ªè„šæœ¬ï¼š

```yaml
executors:
  job:
    scripts:
      linux: plugins/inputs/xxx/xxx_discover.sh
      windows: plugins/inputs/xxx/xxx_discover.ps1
    default_script: linux
```

ç³»ç»Ÿä¼šæ ¹æ®ç›®æ ‡ä¸»æœºçš„æ“ä½œç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©å¯¹åº”è„šæœ¬ã€‚

#### Protocol æ–¹å¼ï¼š
Python ä»£ç å¤©ç„¶è·¨å¹³å°ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†ã€‚

---

### Q3: è„šæœ¬è¾“å‡ºæ ¼å¼å¿…é¡»æ˜¯ JSON å—ï¼Ÿ

**æ˜¯çš„**ï¼Œè„šæœ¬å¿…é¡»è¾“å‡ºæœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œä¸”å¿…é¡»åŒ…å«ä»¥ä¸‹ç»“æ„ï¼š

```json
{result": {
    "æ¨¡å‹å": [
      {
        "å­—æ®µ1": "å€¼1",
        ...
      }
    ]
  },
  "success": true }
  ]
}
```

ç³»ç»Ÿä¼šå°†æ­¤ JSON è½¬æ¢ä¸º Prometheus æ ¼å¼ã€‚

---

### Q4: å¦‚ä½•è°ƒè¯•æ’ä»¶ï¼Ÿ

#### 1. è°ƒè¯• Shell è„šæœ¬

```bash
# ç›´æ¥æ‰§è¡Œè„šæœ¬
bash plugins/inputs/your_plugin/your_script.sh

# æ£€æŸ¥è¾“å‡ºæ˜¯å¦ä¸ºæœ‰æ•ˆ JSON
bash plugins/inputs/your_plugin/your_script.sh | python -m json.tool
```

#### 2. è°ƒè¯• Python é‡‡é›†å™¨

```python
# åœ¨é‡‡é›†å™¨ä¸­æ·»åŠ è°ƒè¯•ä»£ç 
from sanic.log import logger

class YourCollector:
    def list_all_resources(self):
        logger.info("Debug: Starting collection...")
        logger.info(f"Debug: params = {self.params}")
        # ...
```

#### 3. æŸ¥çœ‹ Worker æ—¥å¿—

```bash
# Worker æ—¥å¿—
tail -f logs/worker.log

# API æ—¥å¿—
tail -f logs/api.log
```

---

### Q5: å¦‚ä½•å¤„ç†é‡‡é›†å¤±è´¥ï¼Ÿ
é‡‡é›†å™¨åº”è¯¥æ•è·å¼‚å¸¸å¹¶è¿”å›é”™è¯¯æ ¼å¼ï¼š

```python
# Python é‡‡é›†å™¨ä¸­
def list_all_resources(self):
    try:
        # é‡‡é›†é€»è¾‘
        model_data = {...}
        return {"result": {"mysql": [model_data]}, "success": True}
    except Exception as e:
        logger.error(f"Collection failed: {str(e)}")
        # è¿”å›é”™è¯¯æ ¼å¼
        return {"result": {"cmdb_collect_error": str(e)}, "success": False}on failed: {str(e)}")
        raise  # æŠ›å‡ºå¼‚å¸¸ï¼Œç³»ç»Ÿä¼šç”Ÿæˆé”™è¯¯æŒ‡æ ‡
```

é”™è¯¯æŒ‡æ ‡ç¤ºä¾‹ï¼š
```
collection_request_error{model_id="mysql",error="Connection refused"} 1
```

---

### Q6: å¦‚ä½•æ·»åŠ æ–°çš„ä¾èµ–ï¼Ÿ

#### Python ä¾èµ–

```bash
# æ·»åŠ åˆ° pyproject.toml
[tool.poetry.dependencies]
psycopg2-binary = "^2.9.0"

# å®‰è£…
poetry install
```

#### Shell è„šæœ¬ä¾èµ–

ç¡®ä¿ç›®æ ‡ä¸»æœºå·²å®‰è£…æ‰€éœ€å‘½ä»¤ï¼ˆå¦‚ `redis-cli`ã€`mysql` ç­‰ï¼‰ã€‚

---

### Q7: å¦‚ä½•æ”¯æŒå¹¶å‘é‡‡é›†å¤šä¸»æœºï¼Ÿ

ç³»ç»Ÿè‡ªåŠ¨æ”¯æŒï¼Œæ— éœ€ç‰¹æ®Šé…ç½®ï¼š

```python
# service/collection_service.py ä¼šè‡ªåŠ¨åˆ¤æ–­
if len(self.hosts) >= 2:
    # å¯ç”¨å¹¶å‘æ¨¡å¼
    collect_data = await self._collect_concurrent(executor_config)
else:
    # å•ä¸»æœºæ¨¡å¼
    collect_data = await self._collect_sequential(executor_config)
```

---

## é™„å½•

### ç›®å½•ç»“æ„é€ŸæŸ¥

```
stargazer/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ collect.py              # API æ¥å£
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ task_queue.py           # ä»»åŠ¡é˜Ÿåˆ—
â”‚   â”œâ”€â”€ worker.py               # ARQ Worker
â”‚   â”œâ”€â”€ plugin_executor.py     # æ’ä»¶æ‰§è¡Œå™¨
â”‚   â””â”€â”€ yaml_reader.py          # YAML è¯»å–å™¨
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ script_executor.py      # SSH è„šæœ¬æ‰§è¡Œå™¨
â”‚   â””â”€â”€ inputs/
â”‚       â”œâ”€â”€ mysql/              # MySQL æ’ä»¶
â”‚       â”‚   â”œâ”€â”€ plugin.yml
â”‚       â”‚   â””â”€â”€ mysql_info.py
â”‚       â”œâ”€â”€ redis/              # Redis æ’ä»¶
â”‚       â”‚   â”œâ”€â”€ plugin.yml
â”‚       â”‚   â””â”€â”€ redis_default_discover.sh
â”‚       â””â”€â”€ your_plugin/        # ğŸ†• ä½ çš„æ’ä»¶
â”‚           â”œâ”€â”€ __init__.py
â”‚           â”œâ”€â”€ plugin.yml
â”‚           â””â”€â”€ your_collector.py / your_script.sh
â”œâ”€â”€ service/
â”‚   â””â”€â”€ collection_service.py   # é‡‡é›†æœåŠ¡
â””â”€â”€ tasks/
    â””â”€â”€ handlers/
        â””â”€â”€ plugin_handler.py   # æ’ä»¶ä»»åŠ¡å¤„ç†å™¨
```

### å¿«é€Ÿå¼€å§‹æ¸…å•

- [ ] ç¡®å®šæ’ä»¶åç§°å’Œæ¨¡å‹ ID
- [ ] åœ¨ `plugins/inputs/` ä¸‹åˆ›å»ºæ’ä»¶ç›®å½•
- [ ] åˆ›å»º `__init__.py`ï¼ˆç©ºæ–‡ä»¶ï¼‰
- [ ] ç¼–å†™ `plugin.yml` é…ç½®æ–‡ä»¶
- [ ] é€‰æ‹©é‡‡é›†æ–¹å¼ï¼š
  - [ ] Job: ç¼–å†™ Shell è„šæœ¬ï¼Œè¾“å‡º JSON
  - [ ] Protocol: ç¼–å†™ Python ç±»ï¼Œå®ç° `list_all_resources()`
- [ ] æµ‹è¯•è„šæœ¬/é‡‡é›†å™¨å•ç‹¬è¿è¡Œ
- [ ] å¯åŠ¨ Worker æµ‹è¯•å®Œæ•´æµç¨‹
- [ ] éªŒè¯ Prometheus æ ¼å¼è¾“å‡º

---

## è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- ä½œè€…ï¼šWeOps Team
- é¡¹ç›®ä»“åº“ï¼š[GitHub Link]

**ç¥ä½ å¼€å‘é¡ºåˆ©ï¼** ğŸ‰
