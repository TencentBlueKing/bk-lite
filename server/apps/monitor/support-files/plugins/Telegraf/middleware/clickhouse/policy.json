{
  "object": "ClickHouse",
  "plugin": "ClickHouse",
  "templates": [
    {
      "name": "实例存活状态",
      "alert_name": "ClickHouse节点 ${metric_instance_id} 服务中断",
      "description": "监测服务持续运行时间（秒），异常重启可能导致查询失败。需检查systemd日志和OOM状态。",
      "metric_name": "clickhouse_asynchronous_metrics_uptime",
      "algorithm": "last_over_time",
      "threshold": [
        {
          "level": "critical",
          "value": 60,
          "method": "<="
        }
      ]
    },
    {
      "name": "查询频率突增",
      "alert_name": "ClickHouse集群 ${metric_instance_id} 查询过载",
      "description": "监控SELECT查询速率，异常增长可能导致CPU饱和。需检查客户端行为或限流。",
      "metric_name": "clickhouse_events_select_query",
      "algorithm": "avg",
      "threshold": [
        {
          "level": "critical",
          "value": 1000,
          "method": ">="
        },
        {
          "level": "error",
          "value": 500,
          "method": ">="
        },
        {
          "level": "warning",
          "value": 200,
          "method": ">="
        }
      ]
    },
    {
      "name": "活跃分区异常",
      "alert_name": "ClickHouse表 ${metric_instance_id} 分区泄漏",
      "description": "监控活跃part数量，过多会导致MergeTree性能下降。需检查OPTIMIZE TABLE执行状态。",
      "metric_name": "clickhouse_metrics_parts_active",
      "algorithm": "max",
      "threshold": [
        {
          "level": "critical",
          "value": 100000,
          "method": ">="
        },
        {
          "level": "error",
          "value": 50000,
          "method": ">="
        },
        {
          "level": "warning",
          "value": 10000,
          "method": ">="
        }
      ]
    },
    {
      "name": "过时分区堆积",
      "alert_name": "ClickHouse表 ${metric_instance_id} 合并延迟",
      "description": "监控outdated parts数量，过多会影响查询效率。需检查后台Merge任务状态。",
      "metric_name": "clickhouse_metrics_parts_outdated",
      "algorithm": "last_over_time",
      "threshold": [
        {
          "level": "critical",
          "value": 10000,
          "method": ">="
        },
        {
          "level": "error",
          "value": 5000,
          "method": ">="
        },
        {
          "level": "warning",
          "value": 1000,
          "method": ">="
        }
      ]
    },
    {
      "name": "系统可用内存",
      "alert_name": "ClickHouse节点 ${metric_instance_id} 内存紧张",
      "description": "检测操作系统可用内存，不足会触发OOM Killer。需检查内存泄漏或调整配置。",
      "metric_name": "clickhouse_asynchronous_metrics_os_memory_available",
      "algorithm": "min",
      "threshold": [
        {
          "level": "critical",
          "value": 1,
          "method": "<="
        },
        {
          "level": "error",
          "value": 2,
          "method": "<="
        },
        {
          "level": "warning",
          "value": 4,
          "method": "<="
        }
      ]
    },
    {
      "name": "查询请求突增",
      "alert_name": "ClickHouse集群 ${metric_instance_id} 查询风暴",
      "description": "监控总查询速率，异常增长可能导致资源耗尽。需检查客户端行为。",
      "metric_name": "clickhouse_events_query",
      "algorithm": "max",
      "threshold": [
        {
          "level": "critical",
          "value": 1000,
          "method": ">="
        },
        {
          "level": "error",
          "value": 500,
          "method": ">="
        },
        {
          "level": "warning",
          "value": 200,
          "method": ">="
        }
      ]
    },
    {
      "name": "查询效率下降",
      "alert_name": "ClickHouse集群 ${metric_instance_id} 扫描量过大",
      "description": "监控压缩后读取数据量，突增表明全表扫描。需优化索引或查询。",
      "metric_name": "clickhouse_events_compressed_read_buffer_bytes",
      "algorithm": "max",
      "threshold": [
        {
          "level": "critical",
          "value": 170,
          "method": ">="
        },
        {
          "level": "error",
          "value": 85,
          "method": ">="
        },
        {
          "level": "warning",
          "value": 17,
          "method": ">="
        }
      ]
    }
  ]
}