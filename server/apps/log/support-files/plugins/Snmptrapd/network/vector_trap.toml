# ====================================
# Vector SNMP Trap 接收配置
# 通过 Unix Socket 接收 snmptrapd 的 trap（同主机最优方案）
# ====================================

# ====================================
# Source: Unix Socket 接收 trap
# ====================================
[sources.snmp_trap]
type = "socket"
mode = "unix_datagram"
path = "/var/run/vector/snmp_trap.sock"
max_length = 102400

# ====================================
# Transform: 解析 trap 数据
# ====================================
[transforms.snmp_trap_parse]
type = "remap"
inputs = ["snmp_trap"]
source = '''
# 基础标记
.collector = "Snmptrapd"
.collect_type = "snmp_trap"
.event_type = "snmp_trap"

# 解析 trap 消息
# snmptrapd 输出格式示例：
# "hostname [UDP: [192.168.1.1]:161->[192.168.1.254]:162]:\niso.3.6.1.6.3.1.1.4.1.0 = OID: iso.3.6.1.6.3.1.1.5.3"

msg = string!(.message)

# 提取 UDP 源地址
udp_match = parse_regex(msg, r"UDP:\s*\[(?P<src_ip>[^\]]+)\]")
if udp_match != null {
  .source_ip = string!(udp_match.src_ip)
  .source = .source_ip
}

# 提取 trap OID
# 查找 snmpTrapOID 的值
oid_match = parse_regex(msg, r"(?:iso|1)\.3\.6\.1\.6\.3\.1\.1\.4\.1\.0\s*=\s*OID:\s*(?:iso\.)?(?P<oid>[\d\.]+)")
if oid_match != null {
  .trap_oid = "1." + string!(oid_match.oid)

  # 识别常见 trap 类型
  oid = .trap_oid
  if starts_with(oid, "1.3.6.1.6.3.1.1.5.3") {
    .trap_type = "linkDown"
    .severity = "warning"
  } else if starts_with(oid, "1.3.6.1.6.3.1.1.5.4") {
    .trap_type = "linkUp"
    .severity = "info"
  } else if starts_with(oid, "1.3.6.1.6.3.1.1.5.1") {
    .trap_type = "coldStart"
    .severity = "critical"
  } else if starts_with(oid, "1.3.6.1.6.3.1.1.5.2") {
    .trap_type = "warmStart"
    .severity = "warning"
  } else if starts_with(oid, "1.3.6.1.6.3.1.1.5.5") {
    .trap_type = "authenticationFailure"
    .severity = "error"
  } else {
    .trap_type = "custom"
    .severity = "info"
  }
} else {
  .trap_type = "unknown"
  .trap_oid = "unknown"
  .severity = "info"
}

# 时间戳
.timestamp = now()

# 保留原始消息
.raw_message = msg
'''

# ====================================
# Sink: 发送到 NATS
# ====================================
[sinks.snmp_trap_nats]
type = "nats"
inputs = ["snmp_trap_parse"]
subject = "snmp.trap"
url = "${NATS_PROTOCOL}://${NATS_SERVERS}"

[sinks.snmp_trap_nats.auth]
strategy = "user_password"

[sinks.snmp_trap_nats.auth.user_password]
user = "${NATS_USERNAME}"
password = "${NATS_PASSWORD}"

[sinks.snmp_trap_nats.encoding]
codec = "json"

# ====================================
# Sink: 本地日志备份（可选）
# ====================================
[sinks.snmp_trap_log]
type = "file"
inputs = ["snmp_trap_parse"]
path = "/var/log/snmp_traps/trap_%Y%m%d.log"
idle_timeout_secs = 30

[sinks.snmp_trap_log.encoding]
codec = "json"
