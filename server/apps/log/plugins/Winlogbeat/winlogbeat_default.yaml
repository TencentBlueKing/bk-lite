# ================================== General ===================================
name: "winlogbeat-${node.ip}-${node.cloud_region}"
tags: ["bk-lite", "logstash", "windows"]
# ================================== Logging ===================================
logging.level: info
logging.to_files: true
logging.files:
  path: C:\ProgramData\fusion-collectors\log\winlogbeat
  name: winlogbeat
  keepfiles: 7
  permissions: 0600
# ================================== Outputs ===================================
output.logstash:
  hosts: ["localhost:15044"]
  worker: 1
  bulk_max_size: 2048
  timeout: 30s
  max_retries: 3
# ================================== Processors ===================================
processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded

  - script:
      lang: javascript
      source: >
        function process(event) {
          var evt = event.Get();
          
          // 标准化时间戳
          if (evt['@timestamp']) {
            event.Put('timestamp', evt['@timestamp']);
          }
          
          // Windows 事件基础信息
          if (evt.winlog) {
            event.Put('event_id', evt.winlog.event_id || 0);
            event.Put('event_provider', evt.winlog.provider_name || 'unknown');
            event.Put('event_channel', evt.winlog.channel || 'unknown');
            event.Put('computer_name', evt.winlog.computer_name || evt.host.name || 'unknown');
            
            // 基础用户信息提取
            if (evt.winlog.event_data) {
              var eventData = evt.winlog.event_data;
              if (eventData.TargetUserName) {
                event.Put('target_user_name', eventData.TargetUserName);
              }
            }
          }
          
          return event;
        }


# ================================== Event Logs ===================================
winlogbeat.event_logs:
# ================================== 健康检查模式 - 最小数据量 ==================================
- name: Security
  level: warning  # 只采集warning及以上级别，减少数据量
  event_id: 4625  # 仅监控登录失败事件，用于验证功能
  ignore_older: 30m  # 缩短到30分钟，与其他Beat保持一致

  fields:
    log_type: "winlogbeat"
    component: "security"
    health_check_mode: true
    node_ip: "${node.ip}"
    cloud_region: "${node.cloud_region}"
  fields_under_root: false
