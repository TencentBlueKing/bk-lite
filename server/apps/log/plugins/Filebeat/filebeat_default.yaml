# ================================== General ===================================
name: "filebeat-${node.ip}-${node.cloud_region}"
tags: ["bk-lite", "logstash"]

# ================================== Logging ===================================
logging.level: info
logging.to_files: true
logging.files:
  path: /opt/fusion-collectors/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0600

# ================================== Outputs ===================================
output.logstash:
  hosts: ["localhost:15044"]
  worker: 1
  bulk_max_size: 2048
  timeout: 30s
  max_retries: 3

# ================================== Processors ===================================
processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded

# ================================== Inputs ===================================
filebeat.inputs:
- type: log
  enabled: true

  # 监控 Filebeat 自身日志文件
  paths:
    - /opt/fusion-collectors/log/filebeat/filebeat-*.ndjson

  # 资源友好的扫描配置
  scan_frequency: 300s  # 从60s改为300s，大幅减少扫描频率
  close_inactive: 300s  # 增加到5分钟，减少文件句柄操作
  ignore_older: 1h     # 从5m改为1h，减少文件状态检查

  # 过滤掉所有 Filebeat 内部运行日志
  exclude_lines:
    - '"log.logger":"monitoring"'
    - '"log.logger":"crawler"'
    - '"monitoring":{"metrics"'

  # 只保留错误和关键信息
  include_lines:
    - '"log.level":"error"'
    - '"log.level":"fatal"'

  fields:
    log_type: "filebeat"
    health_check_mode: true
    _msg: "health check"
  fields_under_root: true
