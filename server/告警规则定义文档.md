# 告警规则（Rule）定义文档

## 概述

告警规则系统采用分层设计，通过 **AggregationRules（聚合规则）** 和 **CorrelationRules（关联规则）** 两层模型，实现灵活的事件聚合和告警生成。系统支持多种窗口类型和复杂的过滤条件，能够将原始事件（Event）按照业务需求聚合为有意义的告警（Alert）。

## 核心概念

### 1. 数据流转链路
```
原始事件(Event) → 规则过滤与聚合 → 告警(Alert)
      ↓
  AggregationRules  →  CorrelationRules  →  DuckDB SQL  →  Alert
  （聚合规则）      （关联规则）        （SQL执行）   （告警生成）
```

### 2. 关键模型

#### Event（原始事件）
- **作用**：系统接收的最原始的监控数据
- **来源**：各种监控系统、APM工具、日志系统等
- **核心字段**：
  - `event_id`: 事件唯一标识
  - `title/description`: 事件标题和描述
  - `level`: 事件级别（info/warning/error/critical）
  - `resource_id/resource_type/resource_name`: 资源标识信息
  - `item`: 监控指标名称
  - `value`: 监控数值
  - `start_time/received_at`: 时间戳
  - `labels`: 元数据JSON
  - `fingerprint`: 事件指纹（用于聚合）

#### AggregationRules（聚合规则）
- **作用**：定义如何对原始事件进行过滤和聚合
- **核心字段**：
  - `rule_id`: 规则唯一标识
  - `condition`: 规则条件配置（JSON格式）
  - `template_title/template_content`: 告警模板
  - `severity`: 告警严重程度
  - `is_active`: 规则激活状态

#### CorrelationRules（关联规则）
- **作用**：定义窗口类型、时间配置等聚合策略
- **核心字段**：
  - `window_type`: 窗口类型（sliding/fixed/session）
  - `window_size`: 窗口大小（如"10min"）
  - `slide_interval`: 滑动间隔
  - `session_timeout`: 会话超时
  - `aggregation_rules`: 关联的聚合规则（多对多）

## 规则配置详解

### 1. 条件配置（condition字段）

AggregationRules的condition字段采用JSON数组格式，支持复杂的过滤和聚合条件：

```json
[
    {
        "filter": {
            "resource_type": {
                "operator": "==",
                "value": "网站拨测"
            },
            "item": {
                "operator": "==", 
                "value": "status"
            },
            "value": {
                "operator": "==",
                "value": 0
            }
        },
        "level": "warning",
        "operator": ">=",
        "aggregation_key": ["fingerprint"],
        "window_config": {
            "window_type": "sliding",
            "window_size": 1,
            "slide_interval": 1,
            "time_column": "start_time"
        },
        "aggregation_rules": {
            "min_event_count": 1,
            "include_labels": true,
            "include_stats": true,
            "custom_aggregations": {
                "failure_count": "COUNT(*)",
                "first_failure_time": "MIN(start_time)",
                "affected_urls": "STRING_AGG(DISTINCT labels->'url', ',')"
            }
        }
    }
]
```

### 2. 过滤条件（filter）

支持的操作符：
- **比较操作符**：`==`, `!=`, `>`, `<`, `>=`, `<=`
- **集合操作符**：`IN`, `NOT IN`
- **字符串操作符**：`LIKE`, `NOT LIKE`

常用过滤字段：
- `resource_type`: 资源类型过滤
- `resource_name`: 资源名称过滤
- `item`: 监控指标过滤
- `level`: 事件级别过滤
- `value`: 数值范围过滤

### 3. 聚合配置（aggregation_rules）

```json
{
    "min_event_count": 1,           // 最小事件数量阈值
    "include_labels": true,         // 是否包含标签聚合
    "include_stats": true,          // 是否包含统计信息
    "custom_aggregations": {        // 自定义聚合函数
        "failure_count": "COUNT(*) FILTER (WHERE value = 0)",
        "avg_response_time": "AVG(value) FILTER (WHERE item = 'response_time')",
        "affected_hosts": "STRING_AGG(DISTINCT resource_name, ',')"
    }
}
```

## 窗口类型详解

### 1. 滑动窗口（Sliding Window）
- **特点**：窗口持续滑动，每分钟执行一次
- **优势**：实时性强，能快速发现问题
- **劣势**：可能产生重复告警
- **适用场景**：实时监控、故障快速响应

```json
{
    "window_type": "sliding",
    "window_size": 5,        // 5分钟窗口
    "slide_interval": 1,     // 每1分钟滑动一次
    "time_column": "received_at"
}
```

### 2. 固定窗口（Fixed Window）
- **特点**：窗口边界对齐时间间隔，避免重复处理
- **优势**：无重复告警，资源消耗低
- **劣势**：可能存在延迟
- **适用场景**：定期统计、报表生成

```json
{
    "window_type": "fixed", 
    "window_size": 15,       // 15分钟窗口
    "alignment": "minute"    // 按分钟对齐
}
```

### 3. 会话窗口（Session Window）
- **特点**：基于事件间隔动态调整窗口
- **优势**：智能检测"活动停止"状态
- **劣势**：逻辑相对复杂
- **适用场景**：故障跟踪、SLA监控

```json
{
    "window_type": "session",
    "session_timeout": "10min",     // 会话超时时间
    "session_key_fields": ["fingerprint"]  // 会话分组字段
}
```

## 内置规则示例

### 1. 高级别事件聚合规则
```json
{
    "rule_id": "high_level_event_aggregation",
    "name": "High Level Event Aggregation", 
    "description": {
        "zh": "高级别事件聚合规则。过滤warning以上级别事件，按对象实例聚合。",
        "en": "High level event aggregation rule. Filters events above warning level."
    },
    "severity": "warning",
    "condition": [
        {
            "filter": {
                "level": {
                    "operator": "<=",
                    "value": 2
                }
            },
            "aggregation_key": ["fingerprint"],
            "window_config": {
                "window_type": "fixed",
                "window_size": 5
            }
        }
    ]
}
```

### 2. 网站拨测异常规则
```json
{
    "rule_id": "critical_event_aggregation",
    "name": "Critical Event Aggregation",
    "description": {
        "zh": "网站拨测异常检测，1分钟内状态异常立即告警。"
    },
    "condition": [
        {
            "filter": {
                "resource_type": {"operator": "==", "value": "网站拨测"},
                "item": {"operator": "==", "value": "status"},
                "value": {"operator": "==", "value": 0}
            },
            "window_config": {
                "window_type": "sliding", 
                "window_size": 1,
                "slide_interval": 1
            }
        }
    ]
}
```

### 3. CI/CD故障处理规则
```json
{
    "rule_id": "error_scenario_handling",
    "name": "Error Scenario Handling",
    "description": {
        "zh": "CI/CD构建失败后10分钟无人工干预则告警。"
    },
    "condition": [
        {
            "filter": {
                "resource_type": {"operator": "==", "value": "jenkins"},
                "item": {"operator": "==", "value": "jenkins_build_status"},
                "value": {"operator": "==", "value": 0}
            },
            "window_config": {
                "window_type": "session",
                "session_timeout": "10min"
            },
            "session_close": {
                "filter": {
                    "resource_type": {"operator": "==", "value": "jenkins"},
                    "item": {"operator": "==", "value": "jenkins_build_status"}, 
                    "value": {"operator": "==", "value": 1}
                },
                "action": "close_session"
            }
        }
    ]
}
```

## 规则处理流程

### 1. 规则转换流程
```
AggregationRules(JSON配置) 
    ↓ JSONRuleConverter
TemplateContext(结构化对象)
    ↓ TemplateEngine
DuckDB SQL(可执行SQL)
    ↓ DuckDBEngine
聚合结果(DataFrame)
    ↓ AlertProcessor
Alert(告警对象)
```

### 2. 核心组件

#### JSONRuleConverter（规则转换器）
- **职责**：将JSON配置转换为TemplateContext对象
- **输入**：AggregationRules模型实例
- **输出**：TemplateContext对象
- **关键方法**：`convert_aggregation_rule_to_context()`

#### TemplateEngine（模板引擎）
- **职责**：基于Jinja2生成DuckDB SQL
- **输入**：TemplateContext对象
- **输出**：可执行的SQL语句
- **模板文件**：支持不同窗口类型的SQL模板

#### TemplateContext（模板上下文）
```python
@dataclass
class TemplateContext:
    table: str = 'alerts_event'                    # 数据源表
    time_column: str = 'start_time'                # 时间字段
    window_size: int = 5                           # 窗口大小
    window_type: str = 'fixed'                     # 窗口类型
    slide_interval: int = 1                        # 滑动间隔
    resource_filters: List[FilterCondition] = []   # 资源过滤条件
    threshold_conditions: List[FilterCondition] = [] # 阈值条件
    group_by_fields: List[str] = []                # 分组字段
    aggregation_rules: AggregationRules = None     # 聚合规则
```

## 规则管理

### 1. 规则激活与调度
- 通过`SmartWindowScheduler`智能调度器判断执行时机
- 根据窗口类型和当前时间确定是否执行
- 支持DEBUG模式下强制执行所有规则

### 2. 规则生效机制
- **滑动窗口**：每分钟都执行
- **固定窗口**：按时间对齐执行（如每5分钟的整点）
- **会话窗口**：根据超时配置动态执行

### 3. 规则配置建议
1. **窗口大小**：根据监控频率设置（1-60分钟常见）
2. **聚合维度**：包含关键业务标识（主机ID、服务名等）
3. **过滤条件**：尽量具体，减少无关数据扫描
4. **阈值设置**：结合业务场景设置合理触发条件
5. **模板内容**：包含足够的上下文信息便于问题定位

## 扩展性设计

### 1. 自定义聚合函数
支持在`custom_aggregations`中定义SQL聚合函数：
```json
{
    "custom_aggregations": {
        "p95_response_time": "PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY value)",
        "error_rate": "COUNT(*) FILTER (WHERE value > 0) * 100.0 / COUNT(*)",
        "unique_users": "COUNT(DISTINCT labels->>'user_id')"
    }
}
```

### 2. 复杂过滤条件
支持嵌套的JSON路径过滤：
```json
{
    "filter": {
        "labels->>'environment'": {"operator": "==", "value": "production"},
        "labels->>'cluster'": {"operator": "IN", "value": ["cluster1", "cluster2"]}
    }
}
```

### 3. 多条件组合
一个AggregationRules可以包含多个condition，支持复杂的业务逻辑组合。

这套规则系统具有高度的灵活性和扩展性，能够满足各种复杂的监控告警需求。通过合理配置规则参数，可以实现从简单的阈值告警到复杂的业务场景检测。
