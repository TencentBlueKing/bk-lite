# 实例展示采集任务名称 Tech Plan（2026-02-27）

## 1. 目标与范围

- 目标：在实例列表与实例详情页，将 `collect_task` 从任务 ID 映射为 `{任务名称}({id})` 展示。
- 范围：实例列表、实例详情。
- 约束：渐进式设计，避免引入复杂权限或多级缓存。

## 2. 方案概述

在 `CollectModelViewSet` 中新增轻量查询 action，返回全量采集任务 `id` 与 `name` 的映射列表。前端将映射缓存 1 小时，并在实例列表/详情渲染时使用该映射格式化 `collect_task`。

## 3. 接口设计

### 3.1 路由与命名

- ViewSet：`CollectModelViewSet`
- Action 命名风格：`snake_case`
- Action 名称：`collect_task_names`
- 路由前缀：`/cmdb/api/collect/`
- 完整路径：`GET /cmdb/api/collect/collect_task_names/`

### 3.2 权限与数据过滤

- 认证：沿用 CMDB 现有认证链路。
- 权限：使用 `auto_collection-View` 权限守卫。
- 数据过滤：不按团队/实例权限过滤，返回全量 `id` + `name` 用于展示名称映射。

### 3.3 响应格式

```json
[
  {
    "id": 1001,
    "name": "K8S-Node-Discover"
  }
]
```

## 4. 前端缓存策略

- 缓存位置：浏览器缓存（前端已有缓存模块）。
- TTL：1 小时。
- 刷新规则：仅在缓存过期时重新请求。

## 5. 展示规则

- `collect_task` 为空：按空值展示规则处理（如空/占位符）。
- `collect_task` 有值且匹配到任务名称：展示 `{任务名称}({id})`。
- `collect_task` 有值但未找到任务：展示 `未找到任务({id})`。

## 6. 影响点

- 新增 CMDB 接口：`CollectModelViewSet.collect_task_names`。
- 实例列表字段渲染逻辑。
- 实例详情字段渲染逻辑。
- 前端任务名称映射与缓存模块。

## 7. 测试方案

- 后端接口：
  - 正常返回全量 `{id, name}` 列表。
  - 无权限访问时返回权限错误。
- 前端展示：
  - `collect_task` 为空时按空值展示规则处理。
  - `collect_task` 有值且可匹配时展示 `{任务名称}({id})`。
  - `collect_task` 有值但未匹配时展示 `未找到任务({id})`。

## 8. 验收对齐

- 列表与详情页 `collect_task` 均按 `{任务名称}({id})` 展示。
- 任务不存在时显示 `未找到任务({id})`。
- 空值不展示错误信息，不影响其他字段显示。

## 9. 待确认项

- 无。

