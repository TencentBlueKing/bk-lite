# 监控系统告警策略调整 Tech Plan（2026-02-27）

## 1. 目标与边界

### 1.1 技术目标
- 在告警模板变量体系中下线前端可见项：`${instance_name}`、`${instance_id}`。
- 新增变量：`${resource_name}`、`${dimension_value}`。
- 保持`${value}`变量语义与渲染行为不变。
- 保证渲染输出满足产品规则：
  - `${resource_name}`仅输出实例名称。
  - `${dimension_value}`按`维度名称:维度值`拼接（维度名称使用展示名），多项以英文逗号`,`连接；**排除 `instance_id` 维度**（因其与 `${resource_name}` 冗余）。

### 1.2 非目标
- 不改通知发送通道。
- 不改分组维度配置入口与存储模型。
- 不做历史告警内容回溯重算。

---

## 2. 影响范围（最小改动）

## 2.1 前端（监控策略配置页）
- 变量候选列表配置：
  - 删除可见项：`instance_name`、`instance_id`。
  - 新增可见项：`resource_name`（显示名：资产名称）、`dimension_value`（显示名：维度值）。
- 变量插入逻辑无需改协议，仅扩展候选项。

## 2.2 后端（模板渲染层）
- 渲染上下文构建器增加字段：
  - `resource_name: str`
  - `dimension_value: str`
- 兼容策略：保留`instance_name`解析（只读兼容，不对外推荐）。

## 2.3 共享规则
- 维度输出顺序严格按“分组维度已选顺序”。
- 空值不输出`null/None/undefined`字样，统一为空字符串。

---

## 3. 数据契约与渲染算法

## 3.1 变量上下文契约（渲染输入）

建议在模板渲染前形成统一上下文字典：

- `resource_name`: 监控对象实例名称（纯名称）
- `dimension_items`: 已选分组维度列表（有序）
  - 结构：`[{"name": "维度名称", "value": "维度值"}, ...]`

派生字段：
- `dimension_value`: 由`dimension_items`格式化得到

## 3.2 格式化函数定义

函数：`format_dimension_value(dimension_items) -> str`

规则：
1. 若`dimension_items`为空，返回`""`。
2. **排除键名为 `instance_id` 的维度**（因其与 `resource_name` 冗余）。
3. 逐项格式化为`{name}:{value}`，其中`value`为空时保留冒号。
4. 多项使用英文逗号`,`拼接，不添加额外空格。

示例：
- 输入：`[{name: "主机IP", value: "1.1.1.1"}]`
  输出：`"主机IP:1.1.1.1"`
- 输入：`[{name: "地域", value: "ap-sh"}, {name: "实例", value: "vm-01"}]`
  输出：`"地域:ap-sh,实例:vm-01"`

## 3.3 兼容策略
- 若模板中仍包含`${instance_name}`，继续按当前旧逻辑解析（长期兼容）。
- 若模板包含`${instance_id}`且历史逻辑允许，保持现状解析；仅在前端不再提供插入入口。

---

## 4. 实施步骤

1) 前端改造
- 调整变量候选项配置。
- 更新变量帮助文案（资产名称、维度值说明）。

2) 后端改造
- 扩展模板渲染上下文构建器。
- 实现`format_dimension_value`并接入`${dimension_value}`变量。

3) 联调验证
- 配置页插入变量 -> 模板预览 -> 实际告警通知文案一致性验证。
- 验证旧模板兼容渲染不报错。

4) 通知发送链路校验（告警名称）
- 在“告警通知发送前”统一完成告警名称模板渲染，禁止在渠道适配层二次拼接变量。
- 渲染结果作为最终`alert_name`写入通知载荷（站内信/IM/邮件等渠道共用同一渲染结果）。
- 若渲染失败，按现有失败策略降级为原始模板或兜底名称，并记录错误日志。

---

## 5. 测试方案

## 5.1 单元测试（后端）
- `format_dimension_value`：
  - 空列表
  - 单维度
  - 多维度
  - 空值维度
  - 非 ASCII 字符（中文维度名）
- 模板渲染：
  - `${resource_name}`正常替换
  - `${dimension_value}`正常替换
  - `${instance_name}`兼容替换

## 5.2 页面测试（前端）
- 变量选择面板不再显示`instance_name`、`instance_id`。
- 能插入`resource_name`、`dimension_value`。
- 帮助文案与显示位置符合方案。

## 5.3 回归测试（端到端）
- 无维度场景告警文案不出现异常占位。
- 多维度场景分隔符固定为`,`且顺序稳定。
- 存量模板发送链路不受影响。
- 告警通知实际下发的“告警名称”与预览渲染结果一致。

---

## 6. 发布与回滚

## 6.1 发布策略
- 先发后端（兼容模式），再发前端（新变量入口）。
- 灰度观察模板渲染错误率与告警发送成功率。

## 6.2 回滚策略
- 前端回滚：恢复旧变量候选列表。
- 后端回滚：撤销新变量映射并保留旧变量逻辑。
- 若仅出现新变量异常，可临时关闭新变量可见入口。

---

## 7. 风险与应对

- 风险：实例名字段来源在不同监控类型不一致。
  - 应对：在上下文构建器中做统一字段映射与兜底。

- 风险：维度顺序来自无序结构导致文案抖动。
  - 应对：输入层改为有序列表，不使用无序 Map 直接迭代。

- 风险：旧模板变量下线误解。
  - 应对：发布说明明确“仅隐藏插入入口，不影响历史渲染（过渡期）”。

---

## 8. 已确认决策

- `resource_name`在不同监控数据源中字段统一，无需额外适配。
- `${value}`保持原样，不做语义和渲染改造。
- `${instance_name}`采用长期兼容策略（运行时可解析，前端不展示插入入口）。
- `${dimension_value}`维度值为空时保留该项（格式为`维度名称:`）。
- `${dimension_value}`中的维度名称统一使用展示名。

## 9. 待确认项（TODO）

- 无。
