# 模型字段支持表格类型

日期：2026-02-28

## 背景

CMDB 数据对象存在多维内在属性（如主机磁盘、进程列表等），单值字段无法完整表达该类结构化信息。

为支持此类场景，CMDB 模型字段需新增“表格类型”，用于在一个字段中维护多行多列数据。

## 需求描述

CMDB 模型字段新增类型 `table`，支持列配置、实例录入与展示、导入导出。

### 1）模型字段定义（新增表格类型）

- 在模型字段类型中新增 `table`。
- `table` 类型支持列配置，列配置项包括：
  - 列名称（用于界面展示）
  - 列 ID（用于数据存储与导入导出映射）
  - 列类型（如：String、Number 等）
- 支持列顺序调整，调整后按最新顺序在录入页、详情页、列表悬浮表格中展示。

### 2）模型配置初始化（model_config.xlsx）

- `model_config.xlsx` 支持配置 `table` 类型字段。
- 表格列配置可在模板中按约定格式填写，并在导入时转换为字段配置。
- 列配置需支持与字段类型联动校验：
  - 列 ID 不可为空、同一字段内不可重复
  - 列名称不可为空
  - 列类型必须为系统支持的合法类型

### 3）实例录入、修改与详情展示

- `table` 类型字段统一采用 JSON 数组结构存储：

```json
[{"name":"xxxx","path":"xxxxxxx"},{}]
```

- 实例录入与修改页面支持：
  - 按列配置渲染表格编辑区
  - 增加/删除行
  - 按列类型进行输入校验
- 详情页按列顺序完整展示表格数据。
- 空值语义：空单元格按空字符串处理。

### 4）实例列表页面展示

- 列表中 `table` 类型字段采用“首列胶囊 + 更多悬浮表格”交互：
  - 默认展示首列前 2 项（胶囊）
  - 若超出 2 项，显示 `+N`
  - 点击 `+N` 或更多入口时，悬浮展示完整表格内容

### 5）实例数据导入导出

- 导出格式：按 Excel 扁平多列展开方式输出（与列配置映射）。
- 导入格式：按 Excel 扁平多列展开方式解析并回写为统一 JSON 存储结构。
- 导入校验至少包括：
  - 字段/列映射存在性校验
  - 列类型校验（如 Number 列必须为数值）
  - 列级规则校验（必填、唯一、长度、正则等）
  - 非法数据行需返回明确错误信息（包含字段与行定位）

## 适用范围

- 模型字段定义与编辑
- 模型配置初始化导入（model_config.xlsx）
- 实例录入与修改
- 实例详情展示
- 实例列表展示
- 实例导入导出

## 非目标（本期不包含）

- 新增复杂嵌套表格（表格单元格内再嵌套表格）
- 跨字段联动计算
- 自定义脚本列类型

## 验收标准

- 模型字段可新增 `table` 类型并完成列配置（名称、ID、类型、顺序）。
- `model_config.xlsx` 可导入 `table` 类型字段配置并通过基础合法性校验。
- 实例录入/修改页面可完成 `table` 字段数据编辑，保存后落库为统一 JSON 数组结构。
- 实例详情页可按配置顺序完整展示表格数据。
- 实例列表页默认展示首列前 2 项胶囊，超出显示 `+N`，并可悬浮查看完整表格。
- 实例导入导出支持扁平多列展开格式，导入后数据与展示一致。
- 列级校验（必填、唯一、长度、正则、类型）生效，错误信息可定位。

## TODO

- TODO: 确认导入模板中“扁平多列展开”的具体列命名规则（确认位置：导入模板生成逻辑、`model_config.xlsx` 模板说明）。
- TODO: 确认列表悬浮表格触发方式（hover/click）与关闭交互规范（确认位置：Web 资产管理列表交互规范文档）。