# 监控系统告警策略调整 Solution Plan（2026-02-27）

## 1. 背景与目标

当前告警名称可选变量中，`${instance_name}`、`${value}`会携带维度信息，无法满足“仅展示实例名”和“独立展示维度值”的表达诉求。

本次目标是在“监控策略配置”页面完成变量可选项与渲染逻辑调整，提升告警文案可读性与可控性。

### 1.1 本期目标
- 隐藏变量：`${instance_name}`、`${instance_id}`。
- 新增变量：`${resource_name}`，仅渲染实例名称，不带维度信息。
- 新增变量：`${dimension_value}`，用于渲染已选分组维度值。
- 保持`${value}`语义与渲染行为不变。

### 1.2 成功标准
- 页面变量选择区不再出现`${instance_name}`、`${instance_id}`。
- 模板中`${resource_name}`可正确渲染为监控对象实例名（无维度拼接）。
- 模板中`${dimension_value}`可正确渲染为“维度名称:维度值”，多项以英文小写逗号分隔。

---

## 2. 范围定义

### 2.1 In Scope
- 监控策略配置页“可选变量”展示项调整。
- 告警模板渲染变量映射调整。
- `${dimension_value}`格式化规则实现。

### 2.2 Out of Scope
- 告警通知渠道新增/改造。
- 分组维度配置能力本身改造。
- 历史告警文案回填与重算。

---

## 3. 方案设计

## 3.1 变量清单调整
- 下线（对前端选择器隐藏）：`${instance_name}`、`${instance_id}`。
- 上线：`${resource_name}`、`${dimension_value}`。

说明：为避免存量模板不可用，后端渲染层可保留`${instance_name}`兼容解析（仅运行时兼容，不在前端暴露）。

## 3.2 `${resource_name}`渲染规则
- 数据来源：告警上下文中的监控对象实例名称字段。
- 输出规则：仅输出实例名称，不拼接任何分组维度或标签信息。
- 空值兜底：实例名缺失时返回空字符串（避免展示`null/undefined`字样）。

## 3.3 `${dimension_value}`渲染规则
- 输入来源：分组维度配置中“已选维度”对应的实时值。
- 单维度格式：`维度名称:维度值`（维度名称使用展示名）。
- 多维度格式：按配置顺序拼接，使用英文小写逗号分隔：`维度1:值1,维度2:值2`。
- 空值处理：
  - 维度值为空时保留键名，值置空（如：`主机IP:`）。
  - 无任何已选维度时返回空字符串。

## 3.4 页面展示文案建议
- `${resource_name}`显示名：资产名称。
- `${dimension_value}`显示名：维度值。
- 展示位置：
  - 资产名称放在“监控对象名称”下。
  - 维度值放在“告警值”下。

---

## 4. 实施步骤

1) 前端变量面板调整
- 移除`${instance_name}`、`${instance_id}`可见项。
- 新增`${resource_name}`、`${dimension_value}`及显示名称。

2) 渲染上下文扩展
- 在告警模板渲染上下文注入`resource_name`、`dimension_value`。
- 增加`dimension_value`格式化函数。

3) 兼容与回归
- 保留`${instance_name}`运行时兼容解析（长期兼容，前端仅隐藏插入入口）。
- 回归变量插入、预览渲染、通知落地文案。

4) 通知链路一致性
- 告警通知发送前统一完成告警名称渲染。
- 通知实际下发的告警名称需与预览渲染结果一致。

---

## 5. 验收清单

- 可选变量列表符合新规则（隐藏2项，新增2项）。
- 插入`${resource_name}`后，告警文案仅显示实例名称。
- 插入`${dimension_value}`后，单/多维度格式符合要求。
- 多维度拼接分隔符为英文逗号`,`，无多余空格。
- 无分组维度时`${dimension_value}`渲染为空字符串。
- 旧模板使用`${instance_name}`不报错（若启用兼容策略）。
- 通知消息中的“告警名称”与模板预览渲染结果一致。

---

## 6. 风险与应对

- 字段来源不一致风险：不同监控类型实例名字段可能不统一。
  - 应对：统一通过渲染上下文适配层输出`resource_name`。

- 维度顺序不稳定风险：渲染顺序影响文案一致性。
  - 应对：严格按“分组维度已选顺序”输出。

- 存量模板影响风险：隐藏变量后用户误以为不再可用。
  - 应对：发布说明中标注“仅隐藏，不影响存量模板渲染（过渡期）”。

---

## 7. 里程碑（最小可交付）

- M1：变量清单调整 + 新变量前端可选。
- M2：后端渲染上下文与格式化逻辑完成。
- M3：联调回归与灰度验证。

---

## 8. 已确认决策

- `resource_name`在不同监控数据源中字段统一，无需额外适配。
- `${value}`保持原样，不做语义和渲染改造。
- `${instance_name}`采用长期兼容策略（运行时可解析，前端不展示插入入口）。
- `${dimension_value}`维度值为空时保留该项（格式为`维度名称:`）。
- `${dimension_value}`中的维度名称统一使用展示名。

## 9. 待确认项（TODO）

- 无。
