# 作业管理模块 Solution Plan（2026-02-26）

## 1. 背景与目标

基于原型目录 `spec/ideas/作业管理/20260226/`，规划作业管理模块落地方案，形成可分阶段实施的交付计划。

### 1.1 业务背景
- 当前需要把“脚本执行、文件分发、Playbook 执行、定时调度、执行追踪、安全拦截”整合为统一作业中心。
- 原型体现了从“创建作业 -> 选择目标 -> 执行 -> 记录查询 -> 详情追溯”的完整闭环。

### 1.2 本期目标（产品级）
- 建立统一作业执行入口（快速执行/文件分发）。
- 建立统一执行历史与详情可追溯能力（按作业、按目标主机、按日志）。
- 建立定时任务能力（简单策略 + Cron）。
- 建立基础作业治理能力（目标管理 + 高危命令/路径规则）。

### 1.3 成功标准
- 用户可在同一模块完成 3 类作业：脚本、文件分发、Playbook。
- 作业从触发到回溯全链路可见（来源、状态、耗时、主机维度日志）。
- 定时任务可配置、启停、立即执行，行为可解释。
- 高危规则可配置并可在执行前触发拦截/二次确认。

---

## 2. 范围定义

## 2.1 In Scope（按原型页面）

### A. 作业执行域
- `快速执行.html`：
  - 作业名称、目标主机、内容来源（作业模版/临时输入）、立即执行。
- `文件分发.html`：
  - 作业名称、目标主机、文件上传、目标路径、覆盖策略、超时、立即执行。

### B. 调度域
- `定时任务.html`：
  - 任务列表、检索、启停、编辑、立即执行、删除。
- `定时任务-新建.html`：
  - 任务名称、目标主机、作业类型、模版选择、简单策略、Cron 策略、并发策略、超时、保存并启用。

### C. 记录与追溯域
- `作业记录.html`：
  - 多维筛选（名称/ID/发起人/状态/类型/来源 + 时间快捷筛选）、分页、详情跳转。
- `作业详情.html`：脚本执行详情（主机维度状态 + 日志 + 脚本查看 + 重新执行）。
- `作业详情-文件分发.html`：文件分发详情（主机维度传输进度/结果 + 文件查看 + 重新执行）。
- `作业详情-Playbook.html`：Playbook 详情（步骤维度结果 + 主机维度状态 + 日志 + 重新执行）。

### D. 作业治理域
- `脚本库.html`、`Playbook库.html`：作业模板来源管理入口。
- `目标管理.html`：目标同步/新增、驱动配置（nats-executor/ssh/ansible）、组织管理。
- `高危命令配置.html`：命令匹配规则、策略（禁止执行/二次确认）、组织、启停。
- `高危路径.html`：路径匹配规则、策略（禁止分发/二次确认）、组织、启停。

## 2.2 Out of Scope（本期不做）
- 跨租户复杂审批流。
- 高级编排（多阶段条件分支工作流）。
- 规则策略的机器学习自动推荐。

---

## 3. 关键业务流程

## 3.1 手动作业执行流程
1) 用户创建作业（脚本/文件分发/Playbook）。
2) 选择目标主机（支持搜索、批量选择）。
3) 提交执行请求。
4) 执行前进行安全规则校验（命令/路径）。
5) 进入执行记录并实时更新状态。
6) 用户在详情页按主机查看结果与日志，支持重新执行。

## 3.2 定时作业流程
1) 创建定时任务（简单策略或 Cron）。
2) 设置并发策略（跳过/运行/排队）和超时。
3) 启用后由调度器触发执行，生成作业记录。
4) 支持任务启停、立即执行、编辑与删除。

## 3.3 历史追溯流程
1) 在作业记录页按维度筛选。
2) 进入详情查看总览信息（来源、状态、耗时、发起人）。
3) 下钻主机维度/步骤维度日志。

---

## 4. 信息架构与能力拆分

## 4.1 一级导航
- 作业执行
- 作业模板
- 目标管理
- 系统配置（高危命令/高危路径）

## 4.2 核心能力模块
- 执行模块：统一受理脚本/文件/Playbook。
- 调度模块：定时触发、并发控制、启停管理。
- 记录模块：执行实例与日志归档、查询与详情。
- 目标模块：目标同步与驱动路由。
- 安全模块：高危规则匹配与执行前控制。

---

## 5. 关键产品规则

## 5.1 作业类型与来源
- 作业类型：脚本执行、文件分发、Playbook。
- 触发来源：手动执行、定时任务、API 调用。

## 5.2 状态集合（产品层）
- 作业状态：执行中、成功、失败、部分失败。
- 目标主机状态：成功、失败、不可达、执行中。
- 定时任务状态：启用、停用。
- 高危规则状态：已启用、已停用。

## 5.3 安全控制策略
- 高危命令：禁止执行 / 二次确认。
- 高危路径：禁止分发 / 二次确认。
- 组织维度规则生效：规则与组织绑定，执行前按目标组织匹配。

## 5.4 调度策略
- 简单策略：每天、每 N 小时、一次性、不启用。
- 复杂策略：Cron（分/时/日/月/周）。
- 并发策略：跳过、运行、排队。

---

## 6. 分阶段实施计划

## M1：执行闭环（优先）
**范围**
- 快速执行、文件分发、作业记录、脚本/文件分发详情。

**交付**
- 支持手动触发作业。
- 记录页可筛选与分页。
- 详情页可按主机查看状态与日志。

**验收标准**
- 三类信息完整：作业信息、主机结果、日志内容。
- 可从创建页面跳转至记录再回到详情形成闭环。

## M2：定时与模板
**范围**
- 定时任务列表与新建、Playbook 详情、模板入口联动。

**交付**
- 定时任务可创建、启停、立即执行。
- 支持简单策略与 Cron 策略。

**验收标准**
- 启用任务可产生记录，停用任务不触发。
- Playbook 详情可查看步骤维度结果。

## M3：治理与安全
**范围**
- 目标管理、高危命令配置、高危路径配置。

**交付**
- 目标同步/新增/驱动配置。
- 高危规则新增、编辑、启停、组织绑定。

**验收标准**
- 命中规则时按策略正确拦截或二次确认。
- 规则生效范围符合组织设置。

---

## 7. 验收清单（按页面）

- 快速执行：可选目标、可选内容来源、可提交执行。
- 文件分发：支持文件上传、目标路径、覆盖策略、超时。
- 定时任务：可检索、启停、立即执行、删除。
- 定时任务新建：简单策略与 Cron 均可保存。
- 作业记录：支持类型/来源/状态/时间筛选，支持分页。
- 作业详情（脚本/文件/Playbook）：可查看主机维度结果与日志，支持重新执行。
- 目标管理：支持同步节点、手工新增、驱动设置。
- 高危命令/路径：支持规则管理、策略选择、组织绑定、启停。

---

## 8. 风险与应对

- 执行链路风险：多驱动（nats-executor/ssh/ansible）行为差异。
  - 应对：统一执行抽象，先保证最小公共能力。

- 调度一致性风险：并发策略与实际执行行为不一致。
  - 应对：先落地“跳过/运行/排队”三种明确定义并补充验收用例。

- 安全误拦截风险：规则表达式过宽影响业务执行。
  - 应对：规则预检与命中预览，默认支持“仅保存”后灰度启用。

- 可观测性风险：执行中断导致日志不完整。
  - 应对：按主机维度保留阶段性状态，日志支持分段持久化。

---

## 9. 依赖与协同

- 与目标管理能力协同：目标来源与筛选能力复用。
- 与执行代理协同：nats-executor / ssh / ansible 执行通道。
- 与权限体系协同：组织维度规则、可见范围与操作权限。

---

## 10. 待确认项（TODO）

- TODO: “作业模板（脚本库/Playbook库）”的数据来源与版本策略。
- TODO: “二次确认”是否需要审计人/审批记录。
- TODO: API 调用触发作业的鉴权粒度与幂等规则。
- TODO: 重新执行时是否允许修改目标范围与参数。

---

## 11. 方案结论

本方案以原型为基准，采用“执行闭环优先、调度与模板其次、治理最后增强”的渐进式落地路径，先保证作业管理主链路可用，再逐步补齐自动化和安全治理能力，满足当前开发启动条件。