# 模型字段支持表格类型

日期：2026-03-02

## 目标

在 CMDB 中新增模型字段类型 `table`，并在不引入复杂架构改造的前提下，打通模型配置、实例录入/编辑/详情、列表展示、导入导出全链路。

## 范围

- 模型字段定义与编辑
- 模型配置初始化导入（`model_config.xlsx`）
- 实例录入、修改、详情
- 实例列表展示
- 实例导入导出

## 已确认决策

- 表格子列类型仅支持：`str`、`number`
- 导入导出采用单列 JSON：`table` 字段独占一列，配置/数据按 JSON 存入单元格
- 列表“更多”交互：`hover` 触发悬浮表格，移出关闭

## 方案概览

采用“后端契约先行、前端渲染适配、导入导出闭环验证”的轻量方案：

1. 在模型字段类型体系中新增 `table`。
2. 统一 `table` 的字段配置结构（列名称、列ID、列类型、顺序）与实例存储结构（JSON 数组）。
3. 在现有实例创建/更新/导入链路中复用字段校验机制，增加 `table` 专项校验。
4. 前端在现有字段渲染框架内扩展 `table` 编辑与展示，不新增页面。
5. 导入导出采用 `table` 字段单列 JSON 存储，确保与实例 JSON 数组双向可逆。

## 数据结构约定

### 1）模型字段 option（table）

```json
[
    {
      "column_id": "name",
      "column_name": "名称",
      "column_type": "str",
      "order": 1
    },
    {
      "column_id": "size",
      "column_name": "容量",
      "column_type": "number",
      "order": 2
    }
  ]
```

### 2）实例值存储

```json
[
  {"name": "disk-a", "size": 100},
  {"name": "disk-b", "size": 200}
]
```

### 3）空值语义

- 单元格空值统一按空字符串处理。
- 行内全空时不计入有效行（导入解析阶段过滤）。

### 4）导入导出单元格约定

- `table` 字段在导入导出模板中独占一列，列名使用字段名称/字段 ID（与现有字段列命名规则保持一致）。
- 单元格内容为 JSON 字符串，语义为该字段完整值（JSON 数组）。
- 导入时先解析 JSON，再按列配置做类型与规则校验；导出时按存储值序列化为 JSON 字符串。

## 分阶段计划

### 阶段一：后端类型与校验落地

**交付内容**
- 新增 `table` 字段类型定义。
- 增加 `table` 列配置校验：
  - 列 ID 必填、唯一、格式合法
  - 列名称必填
  - 列类型仅允许 `str`、`number`
- 增加实例值校验：
  - 字段值必须是 JSON 数组/数组结构
  - `number` 列必须可解析为数值
  - 可扩展支持列级规则（必填、唯一、长度、正则）

**里程碑结果**
- 模型可创建/修改 `table` 字段。
- 实例创建/更新/导入时可对 `table` 值进行统一校验。

### 阶段二：模型初始化与导入导出打通

**交付内容**
- `model_config.xlsx` 解析支持 `table` 字段及列配置。
- 导出支持 `table` 字段独占一列，单元格写入 JSON 字符串。
- 导入支持从该单列 JSON 解析并回写为 JSON 数组。
- 非法数据行返回可定位错误（行号 + 字段/列信息）。

**里程碑结果**
- 模板导出、数据导入、数据导出形成闭环，且往返一致。

### 阶段三：前端录入与展示适配

**交付内容**
- 模型字段配置弹窗支持 `table` 列配置与顺序调整。
- 实例新增/编辑支持动态行增删与按列类型输入。
- 详情页按列顺序完整展示。
- 列表页实现“首列前2项胶囊 + `+N` + hover 悬浮完整表格”。

**里程碑结果**
- 用户可在同一套现有页面完成 `table` 字段的配置、录入、查看与列表浏览。

### 阶段四：联调、回归与发布

**交付内容**
- 前后端联调与需求验收。
- 回归验证：不影响现有 `str/int/enum/time/user/organization/bool/pwd` 字段能力。
- 发布与回滚预案确认。

**里程碑结果**
- 具备灰度上线条件，故障可快速回退。

## 验收清单

- 模型字段可新增 `table`，并可配置列名称/列ID/列类型/顺序。
- 子列类型限制生效：仅允许 `str`、`number`。
- `model_config.xlsx` 可导入 `table` 字段并通过基础合法性校验。
- 实例录入/编辑可维护 `table` 数据，落库存储为统一 JSON 数组结构。
- 实例详情按配置顺序完整展示。
- 实例列表默认展示首列前2项，超出显示 `+N`，hover 可见完整表格。
- 导入导出支持 `table` 字段单列 JSON，导入后展示与导出一致。
- 非法导入数据可返回明确错误信息（至少包含行号、字段、列）。

## 风险与应对

- 风险：历史模型中 `option` 结构不规范导致解析失败。  
  应对：解析阶段增加兼容与默认值兜底，失败时给出字段级错误。

- 风险：单元格 JSON 格式错误或人工编辑导致结构不合法。  
  应对：导入前进行 JSON 解析与结构校验，错误信息明确到行号 + 字段 + JSON 解析原因。

- 风险：列表悬浮展示在大数据量场景下影响渲染性能。  
  应对：仅在 hover 时渲染悬浮内容，默认只渲染首列2项胶囊。

- 风险：`number` 列存在文本污染。  
  应对：导入、实例保存、实例更新三处统一校验，阻断脏数据入库。

## 非目标（本期不做）

- 表格单元格嵌套表格
- 跨字段联动计算
- 自定义脚本列类型
- 超出 `str/number` 之外的子列类型扩展
